
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEO Command Center V3.0 (Streaks & Notes)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .task-list input:checked + label { text-decoration: line-through; color: #6b7280; }
        .section-title { border-bottom: 2px solid #374151; padding-bottom: 8px; margin-bottom: 16px; }
        details > summary { cursor: pointer; list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .progress-bar { background-color: #374151; }
        .progress-bar-inner { background-color: #2563eb; transition: width 0.5s ease-in-out; }
        #calendar .day { cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        #calendar .day:hover { background-color: #374151; }
        #calendar .day.today { border-color: #60a5fa; }
        #calendar .day.selected { background-color: #2563eb; color: white; }
        #calendar .day.perfect { background-color: #16a34a; color: white; }
        #calendar .day.good-effort { background-color: #ca8a04; color: white; }
        #calendar .day.missed { background-color: #dc2626; color: white; }
        /* Style for date inputs */
        input[type="date"] {
            background-color: #4b5563;
            color: #f3f4f6;
            border: 1px solid #6b7280;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.25rem 0.5rem;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        
        /* Calendar day filter styles */
        .calendar-filter-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .calendar-filter-btn.active {
            ring: 2px;
            border-color: #60a5fa; /* blue-400 */
        }
        /* Calendar day visual filter */
        #calendar .day.filtered-out {
            opacity: 0.2;
            pointer-events: none;
        }

        /* Search result styling */
        mark {
            background-color: #fde047; /* yellow-300 */
            color: #1f2937; /* gray-800 */
            padding: 1px 3px;
            border-radius: 3px;
        }
        #search-results::-webkit-scrollbar { width: 8px; }
        #search-results::-webkit-scrollbar-track { background: #374151; border-radius: 4px; }
        #search-results::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        #search-results::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4 sm:p-6 md:p-8">
    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
                
        <div class="lg:col-span-1 space-y-8">
            <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-white section-title">YTD Performance</h2>
                <div class="space-y-4">
                    <div class="text-center bg-gray-700 p-3 rounded-lg">
                        <p class="text-sm text-gray-400">Habit Consistency</p>
                        <p id="habit-consistency" class="text-3xl font-bold text-green-400">0%</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-gray-700 p-3 rounded-lg">
                            <p class="text-sm text-gray-400">Perfect Days</p>
                            <p id="perfect-days" class="text-2xl font-bold">0</p>
                        </div>
                        <div class="bg-gray-700 p-3 rounded-lg">
                            <p class="text-sm text-gray-400">Weight Loss</p>
                            <p id="total-weight-loss" class="text-2xl font-bold">0 lbs</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-gray-700 p-3 rounded-lg">
                            <p class="text-sm text-gray-400">Current Streak üî•</p>
                            <p id="current-streak" class="text-2xl font-bold">0</p>
                        </div>
                        <div class="bg-gray-700 p-3 rounded-lg">
                            <p class="text-sm text-gray-400">Best Streak üèÜ</p>
                            <p id="best-streak" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center">
                            <div id="stats-perfect" class="bg-green-600 text-white font-semibold py-2 px-1 rounded text-sm">0 Perfect</div>
                            <div id="stats-good" class="bg-yellow-600 text-white font-semibold py-2 px-1 rounded text-sm">0 Good</div>
                            <div id="stats-missed" class="bg-red-600 text-white font-semibold py-2 px-1 rounded text-sm">0 Missed</div>
                            <div id="stats-unrated" class="bg-gray-500 text-white font-semibold py-2 px-1 rounded text-sm">0 Unrated</div>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-center text-gray-400 mb-1">Overall Plan Progress</p>
                        <div class="w-full progress-bar rounded-full h-4"><div id="overall-progress" class="progress-bar-inner h-4 rounded-full flex items-center justify-center text-xs font-bold" style="width: 0%">0%</div></div>
                    </div>
                    
                    <div class="border-t border-gray-700 pt-4 mt-4 space-y-3">
                        <label class="block text-sm font-medium text-gray-300">Filter Stats by Date:</label>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label for="filter-start-date" class="block text-xs text-gray-400">Start</label>
                                <input type="date" id="filter-start-date" class="w-full">
                            </div>
                            <div>
                                <label for="filter-end-date" class="block text-xs text-gray-400">End</label>
                                <input type="date" id="filter-end-date" class="w-full">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                             <button id="filter-stats" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded text-sm">Filter</button>
                             <button id="reset-filter" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded text-sm">Reset</button>
                        </div>
                        <p id="filter-status" class="text-sm text-yellow-300 text-center pt-1"></p>
                    </div>
                    </div>
            </section>

            <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month" class="p-2 rounded-md hover:bg-gray-700">&lt;</button>
                    <h2 id="month-year" class="text-xl font-bold"></h2>
                    <button id="next-month" class="p-2 rounded-md hover:bg-gray-700">&gt;</button>
                </div>
                
                <div id="calendar-filter-controls" class="bg-gray-700 p-2 rounded-lg mb-4 flex flex-wrap justify-center gap-2">
                    <button class="calendar-filter-btn bg-blue-600 text-white active" data-filter="all">All</button>
                    <button class="calendar-filter-btn bg-green-600 text-white" data-filter="perfect">Perfect</button>
                    <button class="calendar-filter-btn bg-yellow-600 text-white" data-filter="good-effort">Good Effort</button>
                    <button class="calendar-filter-btn bg-red-600 text-white" data-filter="missed">Missed</button>
                    <button class="calendar-filter-btn bg-gray-500 text-white" data-filter="unrated">Unrated</button>
                </div>
                <div id="calendar" class="grid grid-cols-7 gap-2 text-center">
                    <div class="font-bold">S</div><div class="font-bold">M</div><div class="font-bold">T</div><div class="font-bold">W</div><div class="font-bold">T</div><div class="font-bold">F</div><div class="font-bold">S</div>
                </div>
            </section>

            <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-white section-title">Data Management</h2>
                <div class="flex flex-wrap gap-4">
                    <button id="export-json" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Export JSON</button>
                    <button id="export-csv" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Export CSV</button>
                    <button id="export-ics" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded">Export .ICS</button>
                    <label class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded cursor-pointer">
                        Import JSON
                        <input type="file" id="import-json" class="hidden" accept=".json">
                    </label>
                    <label class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded cursor-pointer">
                        Import CSV
                        <input type="file" id="import-csv" class="hidden" accept=".csv">
                    </label>
                     <button id="reset-data" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Reset Data</button>
                </div>
            </section>
        </div>

        <div class="lg:col-span-2 space-y-8">
            <section id="daily-scorecard" class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-2">
                    <h2 class="text-2xl font-bold text-white section-title">CEO Scorecard</h2>
                    <p id="selected-date-display" class="text-lg text-blue-300 font-semibold"></p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="space-y-4 text-lg">
                        <div class="flex items-center"><input type="checkbox" id="task-business" class="daily-task form-checkbox h-5 w-5"><label for="task-business" class="ml-3">#1 Business Priority</label></div>
                        <div class="flex items-center"><input type="checkbox" id="task-workout" class="daily-task form-checkbox h-5 w-5"><label for="task-workout" class="ml-3">Weight Training</label></div>
                        <div class="flex items-center"><input type="checkbox" id="task-walk" class="daily-task form-checkbox h-5 w-5"><label for="task-walk" class="ml-3">5km Walk</label></div>
                        <div class="flex items-center"><input type="checkbox" id="task-nutrition" class="daily-task form-checkbox h-5 w-5"><label for="task-nutrition" class="ml-3">On-Plan Nutrition</label></div>
                        <div class="flex items-center"><input type="checkbox" id="task-no-alcohol" class="daily-task form-checkbox h-5 w-5"><label for="task-no-alcohol" class="ml-3">No Alcohol</label></div>
                    </div>
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-center mb-3">Weight Progress</h3>
                        <div class="flex justify-around items-center text-center">
                            <div><p class="text-sm text-gray-400">Start</p><p class="text-2xl font-bold">198</p></div>
                            <div><p class="text-sm text-gray-400">Goal</p><p class="text-2xl font-bold">178</p></div>
                            <div><p class="text-sm text-green-400">To Go</p><p id="pounds-to-go" class="text-2xl font-bold text-green-400">20</p></div>
                        </div>
                        <div class="mt-2">
                            <div class="w-full progress-bar rounded-full h-2.5"><div id="weight-progress" class="progress-bar-inner h-2.5 rounded-full"></div></div>
                        </div>
                        <div class="mt-3">
                            <label for="current-weight" class="block text-sm font-medium text-center text-gray-300">Weight for <span id="weight-date">Today</span>:</label>
                            <input type="number" id="current-weight" class="w-full bg-gray-800 text-white text-center text-xl p-1 border-gray-600 rounded-md mt-1" placeholder="Enter">
                        </div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="note-win" class="block text-lg font-medium text-gray-300 mb-2">Today's Biggest Win:</label>
                        <textarea id="note-win" rows="2" class="w-full bg-gray-700 text-gray-200 border-gray-600 rounded-md p-2" placeholder="Business or personal..."></textarea>
                    </div>
                    <div>
                        <label for="note-challenge" class="block text-lg font-medium text-gray-300 mb-2">Today's Biggest Challenge:</label>
                        <textarea id="note-challenge" rows="2" class="w-full bg-gray-700 text-gray-200 border-gray-600 rounded-md p-2" placeholder="What friction did I face?"></textarea>
                    </div>
                    <div>
                        <label for="note-grateful" class="block text-lg font-medium text-gray-300 mb-2">One Thing I'm Grateful For:</label>
                        <textarea id="note-grateful" rows="2" class="w-full bg-gray-700 text-gray-200 border-gray-600 rounded-md p-2" placeholder="..."></textarea>
                    </div>
                </div>
                </section>

            <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-white section-title">Search Notes</h2>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="search-input" class="w-full bg-gray-700 text-gray-200 border-gray-600 rounded-md p-2" placeholder="Enter keyword...">
                    <button id="search-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Search</button>
                </div>
                <div id="search-results" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                    </div>
            </section>

            <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-white section-title">The 12-Month Plan</h2>
                
                <details class="mb-4" open data-season="s1">
                    <summary class="text-xl font-semibold text-blue-300 mb-3">Season 1: August Pre-Season</summary>
                    <div class="w-full progress-bar rounded-full h-2.5 mb-2"><div id="s1-progress" class="progress-bar-inner h-2.5 rounded-full"></div></div>
                    <ul class="task-list list-disc list-inside space-y-2 pl-4 border-l-2 border-gray-700 mt-2">
                        <li><input type="checkbox" id="s1-t1" class="plan-task"><label for="s1-t1" class="ml-2">Commit to Lofty CRM plan.</label></li>
                        <li><input type="checkbox" id="s1-t2" class="plan-task"><label for="s1-t2" class="ml-2">Watch 5 hours of Lofty training.</label></li>
                        <li><input type="checkbox" id="s1-t3" class="plan-task"><label for="s1-t3" class="ml-2">Study BRA, Listing Agreement, APS.</label></li>
                        <li><input type="checkbox" id="s1-t4" class="plan-task"><label for="s1-t4" class="ml-2">Create Social Media & Google Profiles.</label></li>
                        <li><input type="checkbox" id="s1-t5" class="plan-task"><label for="s1-t5" class="ml-2">Film 2 videos; script 3 more.</label></li>
                        <li><input type="checkbox" id="s1-t6" class="plan-task"><label for="s1-t6" class="ml-2">Schedule Open House Shadowing.</label></li>
                    </ul>
                </details>

                <details class="mb-4" data-season="s2">
                    <summary class="text-xl font-semibold text-green-300 mb-3">Season 2: Q4 Super-Sprint</summary>
                     <div class="w-full progress-bar rounded-full h-2.5 mb-2"><div id="s2-progress" class="progress-bar-inner h-2.5 rounded-full"></div></div>
                    <ul class="task-list list-disc list-inside space-y-2 pl-4 border-l-2 border-gray-700 mt-2">
                        <li><input type="checkbox" id="s2-t1" class="plan-task"><label for="s2-t1" class="ml-2">Host 8+ Open Houses/month.</label></li>
                        <li><input type="checkbox" id="s2-t2" class="plan-task"><label for="s2-t2" class="ml-2">Add 20+ contacts/week to Lofty.</label></li>
                        <li><input type="checkbox" id="s2-t3" class="plan-task"><label for="s2-t3" class="ml-2">Publish 1 video/week.</label></li>
                        <li><input type="checkbox" id="s2-t4" class="plan-task"><label for="s2-t4" class="ml-2">Secure 2 Buyer Rep Agreements.</label></li>
                        <li><input type="checkbox" id="s2-t5" class="plan-task"><label for="s2-t5" class="ml-2">Secure 1 Listing Agreement.</label></li>
                        <li><input type="checkbox" id="s2-t6" class="plan-task"><label for="s2-t6" class="ml-2">Close first transaction.</label></li>
                        <li><input type="checkbox" id="s2-t7" class="plan-task"><label for="s2-t7" class="ml-2">Establish mentor referral partnership.</label></li>
                    </ul>
                </details>

                <details class="mb-4" data-season="s3">
                    <summary class="text-xl font-semibold text-yellow-300 mb-3">Season 3: Active Recharge</summary>
                     <div class="w-full progress-bar rounded-full h-2.5 mb-2"><div id="s3-progress" class="progress-bar-inner h-2.5 rounded-full"></div></div>
                    <ul class="task-list list-disc list-inside space-y-2 pl-4 border-l-2 border-gray-700 mt-2">
                        <li><input type="checkbox" id="s3-t1" class="plan-task"><label for="s3-t1" class="ml-2">Execute 1 hour remote lead follow-up daily.</label></li>
                        <li><input type="checkbox" id="s3-t2" class="plan-task"><label for="s3-t2" class="ml-2">Send weekly automated market updates.</label></li>
                        <li><input type="checkbox" id="s3-t3" class="plan-task"><label for="s3-t3" class="ml-2">Script video content for Spring Market.</label></li>
                        <li><input type="checkbox" id="s3-t4" class="plan-task"><label for="s3-t4" class="ml-2">Coordinate with mentor on active clients.</label></li>
                    </ul>
                </details>

                <details data-season="s4">
                    <summary class="text-xl font-semibold text-red-300 mb-3">Season 4: Spring Market Ramp-Up</summary>
                     <div class="w-full progress-bar rounded-full h-2.5 mb-2"><div id="s4-progress" class="progress-bar-inner h-2.5 rounded-full"></div></div>
                    <ul class="task-list list-disc list-inside space-y-2 pl-4 border-l-2 border-gray-700 mt-2">
                        <li><input type="checkbox" id="s4-t1" class="plan-task"><label for="s4-t1" class="ml-2">Launch "First-Time Buyer" webinar.</label></li>
                        <li><input type="checkbox" id="s4-t2" class="plan-task"><label for="s4-t2" class="ml-2">Increase video production to 2/week.</label></li>
                        <li><input type="checkbox" id="s4-t3" class="plan-task"><label for="s4-t3" class="ml-2">Host client appreciation event.</label></li>
                        <li><input type="checkbox" id="s4-t4" class="plan-task"><label for="s4-t4" class="ml-2">Ask for 5+ online reviews.</label></li>
                        <li><input type="checkbox" id="s4-t5" class="plan-task"><label for="s4-t5" class="ml-2">Review mid-year P&L and adjust budget.</label></li>
                    </ul>
                </details>
            </section>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const storageKey = 'ceoDashboardData_v7'; // Keep same storage key for compatibility
        const startWeight = 198;
        const goalWeight = 178;
        let mainData = {};
        let currentDate = new Date();
        let selectedDate = new Date();
                
        let filterStartDate = null;
        let filterEndDate = null;
        let activeCalendarFilter = 'all'; 
        
        const toYMD = (date) => date.toISOString().slice(0, 10);
        const toDisplayDate = (date) => date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        const dayDiff = (date1, date2) => Math.round(Math.abs(new Date(date1) - new Date(date2)) / (1000 * 60 * 60 * 24));

        const dailyTaskIds = ['task-business', 'task-workout', 'task-walk', 'task-nutrition', 'task-no-alcohol'];
        const dailyTaskLabels = {
            'task-business': '#1 Business Priority',
            'task-workout': 'Weight Training',
            'task-walk': '5km Walk',
            'task-nutrition': 'On-Plan Nutrition',
            'task-no-alcohol': 'No Alcohol'
        };
        const filterStatusEl = document.getElementById('filter-status');
                
        // --- Day Data Helper ---
        function getDayStatus(dayData) {
            if (!dayData) return 'unrated';
            const hasHabitData = dailyTaskIds.some(id => dayData[id] !== undefined);
            if (!hasHabitData) return 'unrated';
                        
            const checkedCount = dailyTaskIds.filter(id => dayData[id]).length;
            if (checkedCount === dailyTaskIds.length) return 'perfect';
            if (checkedCount > 0) return 'good-effort';
            if (dailyTaskIds.some(id => dayData[id] === false)) return 'missed'; // Has data, but nothing checked
                        
            return 'unrated'; // Default case if data is present but ambiguous
        }
        
        function calculateAndRenderStats(startDate, endDate) {
            // --- NEW: Streak Calculation (Always runs on ALL data) ---
            const allSortedDates = Object.keys(mainData).filter(key => key.match(/^\d{4}-\d{2}-\d{2}$/)).sort();
            let bestStreak = 0;
            let tempStreak = 0;

            for (const dateStr of allSortedDates) {
                if (getDayStatus(mainData[dateStr]) === 'perfect') {
                    tempStreak++;
                } else {
                    if (tempStreak > bestStreak) bestStreak = tempStreak;
                    tempStreak = 0;
                }
            }
            if (tempStreak > bestStreak) bestStreak = tempStreak; // Final check

            let currentStreak = 0;
            let checkDate = new Date();
            let todayStr = toYMD(checkDate);

            // If today is unrated, start streak check from yesterday
            if (getDayStatus(mainData[todayStr]) === 'unrated') {
                checkDate.setDate(checkDate.getDate() - 1);
            }

            while (true) {
                let dateStr = toYMD(checkDate);
                if (allSortedDates.includes(dateStr) && getDayStatus(mainData[dateStr]) === 'perfect') {
                    currentStreak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break; // Streak ends
                }
            }
            
            // Update Streak UI
            document.getElementById('current-streak').textContent = currentStreak;
            document.getElementById('best-streak').textContent = bestStreak;
            // --- END NEW ---


            // 1. Calculate Overall Plan Progress (NOT date-filtered)
            const planTasks = document.querySelectorAll('.plan-task');
            const checkedPlanTasks = document.querySelectorAll('.plan-task:checked');
            const overallProgress = planTasks.length > 0 ? (checkedPlanTasks.length / planTasks.length) * 100 : 0;
            const overallProgressBar = document.getElementById('overall-progress');
            overallProgressBar.style.width = `${overallProgress.toFixed(0)}%`;
            overallProgressBar.textContent = `${overallProgress.toFixed(0)}%`;

            // 2. Filter daily data based on parameters
            let datesToProcess;
            let totalDaysInRange = 0;

            if (startDate && endDate) {
                datesToProcess = allSortedDates.filter(dateStr => dateStr >= startDate && dateStr <= endDate);
                filterStatusEl.textContent = `Showing stats for ${startDate} to ${endDate}.`;
                totalDaysInRange = dayDiff(startDate, endDate) + 1;
            } else {
                datesToProcess = allSortedDates;
                filterStatusEl.textContent = 'Showing all-time stats.';
                if (allSortedDates.length > 0) {
                    totalDaysInRange = dayDiff(allSortedDates[0], allSortedDates[allSortedDates.length - 1]) + 1;
                }
            }
            
            // 3. Calculate date-filtered stats
            let totalHabits = 0, totalCheckedHabits = 0, latestWeight = startWeight;
            let perfectDays = 0, goodEffortDays = 0, missedDays = 0;
            let totalDaysWithData = 0;
            
            datesToProcess.forEach(dateStr => {
                const dayData = mainData[dateStr];
                const status = getDayStatus(dayData);
                                
                switch(status) {
                    case 'perfect':
                        perfectDays++;
                        totalDaysWithData++;
                        break;
                    case 'good-effort':
                        goodEffortDays++;
                        totalDaysWithData++;
                        break;
                    case 'missed':
                        missedDays++;
                        totalDaysWithData++;
                        break;
                    case 'unrated':
                        // Check if *any* data exists (e.g., just notes or weight)
                        if (dayData && Object.keys(dayData).length > 0) {
                             totalDaysWithData++;
                        }
                        break;
                }

                // Calculate habit consistency only from days with habit data
                if (status !== 'unrated') {
                     dailyTaskIds.forEach(id => {
                        if (dayData[id] !== undefined) {
                            totalHabits++;
                            if (dayData[id]) totalCheckedHabits++;
                        }
                    });
                }
                               
                if (dayData && dayData['current-weight'] && dayData['current-weight'] !== '') {
                    latestWeight = parseFloat(dayData['current-weight']);
                }
            });
            
            let unratedDays = 0; 
            if (startDate && endDate) { 
                 const allDatesInRange = [];
                 let currentDate = new Date(startDate.replace(/-/g, '/'));
                 const stopDate = new Date(endDate.replace(/-/g, '/'));
                 while (currentDate <= stopDate) {
                     allDatesInRange.push(toYMD(currentDate));
                     currentDate.setDate(currentDate.getDate() + 1);
                 }
                                  
                  let ratedDaysCount = 0;
                 allDatesInRange.forEach(dateStr => {
                     const status = getDayStatus(mainData[dateStr]);
                     if(status !== 'unrated') ratedDaysCount++;
                 });
                 unratedDays = allDatesInRange.length - ratedDaysCount;

            } else {
                unratedDays = datesToProcess.filter(dateStr => getDayStatus(mainData[dateStr]) === 'unrated').length;
                if (filterStatusEl.textContent === 'Showing all-time stats.') {
                     filterStatusEl.textContent += " (Unrated count is approximate)";
                }
            }

            const habitConsistency = totalHabits > 0 ? (totalCheckedHabits / totalHabits) * 100 : 0;
            const totalWeightLoss = startWeight - latestWeight;

            // Update main stat cards
            document.getElementById('habit-consistency').textContent = `${habitConsistency.toFixed(0)}%`;
            document.getElementById('perfect-days').textContent = perfectDays;
            document.getElementById('total-weight-loss').textContent = `${totalWeightLoss.toFixed(1)} lbs`;

            // Update new summary bar
            document.getElementById('stats-perfect').textContent = `${perfectDays} Perfect`;
            document.getElementById('stats-good').textContent = `${goodEffortDays} Good`;
            document.getElementById('stats-missed').textContent = `${missedDays} Missed`;
            document.getElementById('stats-unrated').textContent = `${unratedDays} Unrated`;
        }
        
        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendarEl.innerHTML = '<div class="font-bold">S</div><div class="font-bold">M</div><div class="font-bold">T</div><div class="font-bold">W</div><div class="font-bold">T</div><div class="font-bold">F</div><div class="font-bold">S</div>'; // Reset header
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('month-year').textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
                        
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) calendarEl.insertAdjacentHTML('beforeend', '<div></div>');

            for (let i = 1; i <= daysInMonth; i++) {
                const dayDate = new Date(year, month, i);
                const dayStr = toYMD(dayDate);
                const dayEl = document.createElement('div');
                dayEl.textContent = i;
                dayEl.className = 'day p-2 rounded-md';
                dayEl.dataset.date = dayStr;

                if (dayStr === toYMD(new Date())) dayEl.classList.add('today');
                if (dayStr === toYMD(selectedDate)) dayEl.classList.add('selected');

                const dayData = mainData[dayStr];
                const status = getDayStatus(dayData);
                
                if (status === 'perfect') dayEl.classList.add('perfect');
                else if (status === 'good-effort') dayEl.classList.add('good-effort');
                else if (status === 'missed') dayEl.classList.add('missed');

                // Apply visual filter
                if (activeCalendarFilter !== 'all' && status !== activeCalendarFilter) {
                    dayEl.classList.add('filtered-out');
                }

                calendarEl.appendChild(dayEl);
            }
        }
                        
        function loadDataForDate(dateStr) {
            selectedDate = new Date(dateStr.replace(/-/g, '/')); // Handle Safari date parsing
            document.getElementById('selected-date-display').textContent = toDisplayDate(selectedDate);
            document.getElementById('weight-date').textContent = toYMD(selectedDate) === toYMD(new Date()) ? "Today" : toDisplayDate(selectedDate);

            const dataForDay = mainData[dateStr] || {};
            const planData = mainData['planTasks'] || {};
                        
            document.querySelectorAll('.daily-task').forEach(i => i.checked = dataForDay[i.id] || false);
            document.querySelectorAll('.plan-task').forEach(i => i.checked = planData[i.id] || false);
            
            // NEW: Backward-compatible notes loading
            if (dataForDay['daily-notes']) {
                // Old data exists, populate the 'Win' field
                document.getElementById('note-win').value = dataForDay['daily-notes'] || '';
                document.getElementById('note-challenge').value = '';
                document.getElementById('note-grateful').value = '';
            } else {
                // Load new structured notes
                document.getElementById('note-win').value = dataForDay['note-win'] || '';
                document.getElementById('note-challenge').value = dataForDay['note-challenge'] || '';
                document.getElementById('note-grateful').value = dataForDay['note-grateful'] || '';
            }
            // END NEW

            document.getElementById('current-weight').value = dataForDay['current-weight'] || '';
                        
            updateWeightMetrics();
            updateAllProgressBars();
            calculateAndRenderStats(filterStartDate, filterEndDate);
            renderCalendar();
        }

        function saveData() {
            const dateStr = toYMD(selectedDate);
            if (!mainData[dateStr]) mainData[dateStr] = {};
            if (!mainData['planTasks']) mainData['planTasks'] = {};
                        
            document.querySelectorAll('.daily-task').forEach(i => mainData[dateStr][i.id] = i.checked);
            
            // NEW: Save structured notes
            mainData[dateStr]['note-win'] = document.getElementById('note-win').value;
            mainData[dateStr]['note-challenge'] = document.getElementById('note-challenge').value;
            mainData[dateStr]['note-grateful'] = document.getElementById('note-grateful').value;
            
            // Deprecate old notes, but check if it exists and clear it if we are saving new notes
            if (mainData[dateStr]['daily-notes']) {
                delete mainData[dateStr]['daily-notes'];
            }
            // END NEW

            mainData[dateStr]['current-weight'] = document.getElementById('current-weight').value;
            document.querySelectorAll('.plan-task').forEach(i => mainData['planTasks'][i.id] = i.checked);

            localStorage.setItem(storageKey, JSON.stringify(mainData));
                        
            updateWeightMetrics();
            updateAllProgressBars();
            calculateAndRenderStats(filterStartDate, filterEndDate);
            renderCalendar();
        }

        function updateWeightMetrics() {
            const currentWeightInput = document.getElementById('current-weight');
            const poundsToGoEl = document.getElementById('pounds-to-go');
            const weightProgressBar = document.getElementById('weight-progress');
            const currentWeight = parseFloat(currentWeightInput.value);

            if (currentWeight) {
                const totalLossGoal = startWeight - goalWeight;
                const lossSoFar = startWeight - currentWeight;
                const progress = totalLossGoal > 0 ? (lossSoFar / totalLossGoal) * 100 : 0;
                weightProgressBar.style.width = `${Math.max(0, Math.min(100, progress))}%`;
                                
                const toGo = (currentWeight - goalWeight).toFixed(1);
                poundsToGoEl.textContent = toGo > 0 ? toGo : 'Met!';
            } else {
                poundsToGoEl.textContent = (startWeight - goalWeight).toFixed(1);
                weightProgressBar.style.width = '0%';
            }
        }

        function updateAllProgressBars() {
            ['s1', 's2', 's3', 's4'].forEach(seasonId => {
                const container = document.querySelector(`details[data-season="${seasonId}"]`);
                if (!container) return;
                const tasks = container.querySelectorAll('.plan-task');
                const completedTasks = container.querySelectorAll('.plan-task:checked');
                const progress = tasks.length > 0 ? (completedTasks.length / tasks.length) * 100 : 0;
                const progressBar = document.getElementById(`${seasonId}-progress`);
                if(progressBar) progressBar.style.width = `${progress}%`;
            });
        }
                
        // --- CSV Functions (Unchanged) ---
        function exportToCsv() {
            if (Object.keys(mainData).length === 0) { alert('No data to export!'); return; }
            const jsonData = JSON.stringify(mainData);
            const escapedJsonData = jsonData.replace(/"/g, '""');
            const csvValue = `"${escapedJsonData}"`;
            let csvContent = 'key,value\n';
            csvContent += `"mainData",${csvValue}\n`;
            
            const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `ceo_dashboard_v3.0_backup_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importFromCsv(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    if (lines.length < 2 || !lines[0].trim().toLowerCase().startsWith('key,value')) {
                        throw new Error('Invalid CSV format. Header must be "key,value".');
                    }
                    const dataLine = lines[1];
                    const match = dataLine.match(/^"(.*?)","(.*)"$/);
                    if (!match || match[1] !== 'mainData' || match.length < 3) {
                        throw new Error('CSV does not contain "mainData" key or is formatted incorrectly.');
                    }
                    let jsonData = match[2];
                    jsonData = jsonData.replace(/""/g, '"');
                    const importedData = JSON.parse(jsonData);
                    
                    if (Object.keys(importedData).length > 0) {
                        mainData = importedData;
                        localStorage.setItem(storageKey, JSON.stringify(mainData));
                        loadDataForDate(toYMD(selectedDate));
                        alert('Data imported successfully from CSV!');
                    } else {
                        throw new Error('No valid data found in CSV file.');
                    }
                } catch (error) {
                    alert('Error importing CSV: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // --- ICS Export Function (UPGRADED) ---
        function exportToIcs() {
            const formatIcsText = (text) => {
                if (!text) return '';
                let escapedText = text.replace(/\\/g, '\\\\').replace(/,/g, '\\,').replace(/;/g, '\\;').replace(/\n/g, '\\n');
                let foldedText = '';
                while (escapedText.length > 75) {
                    foldedText += escapedText.substring(0, 75) + '\r\n '; // ' ' at start of new line
                    escapedText = escapedText.substring(75);
                }
                foldedText += escapedText;
                return foldedText;
            };

            let icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//CEOCommandCenter//EN',
                'CALSCALE:GREGORIAN'
            ];

            const allDates = Object.keys(mainData).filter(key => key.match(/^\d{4}-\d{2}-\d{2}$/)).sort();
            const now = new Date().toISOString().replace(/[-:.]/g, '').slice(0, 15) + 'Z';

            for (const dateKey of allDates) {
                const dayData = mainData[dateKey];
                if (!dayData) continue;

                // NEW: Read from all note fields
                const notesWin = dayData['note-win'];
                const notesChallenge = dayData['note-challenge'];
                const notesGrateful = dayData['note-grateful'];
                const oldNotes = dayData['daily-notes']; // For backward compatibility
                const hasTasks = dailyTaskIds.some(id => dayData[id] !== undefined);

                let description = '';
                
                if (hasTasks) {
                    description += 'Daily Habits:\\n';
                    dailyTaskIds.forEach(id => {
                        const status = dayData[id] ? '‚úÖ' : (dayData[id] === false ? '‚ùå' : '‚ûñ');
                        description += `${status} ${dailyTaskLabels[id]}\\n`;
                    });
                    description += '\\n';
                }

                // NEW: Add structured notes to description
                if (notesWin) description += 'Today\'s Win:\\n' + notesWin + '\\n\\n';
                if (notesChallenge) description += 'Today\'s Challenge:\\n' + notesChallenge + '\\n\\n';
                if (notesGrateful) description += 'Grateful For:\\n' + notesGrateful + '\\n\\n';
                // Only show old notes if new ones are empty (from an old import)
                if (oldNotes && !notesWin && !notesChallenge && !notesGrateful) {
                     description += 'Notes:\\n' + oldNotes;
                }
                // END NEW
                
                if (description === '') continue; // Skip if no tasks and no notes

                const eventDate = dateKey.replace(/-/g, ''); // YYYYMMDD
                
                icsContent.push(
                    'BEGIN:VEVENT',
                    `UID:${dateKey}@ceo.command.center`,
                    `DTSTAMP:${now}`,
                    `DTSTART;VALUE=DATE:${eventDate}`,
                    `SUMMARY:CEO Scorecard - ${dateKey}`,
                    `DESCRIPTION:${formatIcsText(description)}`,
                    'END:VEVENT'
                );
            }

            icsContent.push('END:VCALENDAR');

            const dataStr = icsContent.join('\r\n');
            const dataBlob = new Blob([dataStr], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ceo_dashboard_v3.0_export_${new Date().toISOString().slice(0,10)}.ics`;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
        // --- END ICS ---

        // --- Search Function (UPGRADED) ---
        function performSearch() {
            const searchResultsEl = document.getElementById('search-results');
            const searchTerm = document.getElementById('search-input').value.trim();
            
            if (searchTerm === '') {
                searchResultsEl.innerHTML = '';
                return;
            }
            
            const searchLower = searchTerm.toLowerCase();
            const results = [];

            for (const dateKey of Object.keys(mainData)) {
                if (dateKey.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const dayData = mainData[dateKey];
                    if (!dayData) continue;

                    // NEW: Search all note fields
                    const oldNotes = dayData['daily-notes'] || '';
                    const noteWin = dayData['note-win'] || '';
                    const noteChallenge = dayData['note-challenge'] || '';
                    const noteGrateful = dayData['note-grateful'] || '';

                    const combinedNotes = `${noteWin} ${noteChallenge} ${noteGrateful} ${oldNotes}`.trim();
                    // END NEW

                    if (combinedNotes.toLowerCase().includes(searchLower)) {
                        results.push({
                            date: dateKey,
                            note: combinedNotes // Pass the combined notes for highlighting
                        });
                    }
                }
            }

            results.sort((a, b) => b.date.localeCompare(a.date));

            if (results.length === 0) {
                searchResultsEl.innerHTML = '<p class="text-gray-400">No notes found matching your search.</p>';
            } else {
                const searchRegex = new RegExp(searchTerm, 'gi');
                searchResultsEl.innerHTML = results.map(result => {
                    const escapedNote = result.note.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    // Highlighting will now work across the combined text
                    const highlightedNote = escapedNote.replace(searchRegex, (match) => `<mark>${match}</mark>`);
                    const displayDate = toDisplayDate(new Date(result.date.replace(/-/g, '/')));

                    return `
                        <div class="search-result-item p-3 bg-gray-700 rounded-md cursor-pointer hover:bg-gray-600" data-date="${result.date}">
                            <p class="font-semibold text-blue-300">${displayDate}</p>
                            <p class="text-sm text-gray-300 whitespace-pre-wrap break-words">${highlightedNote}</p>
                        </div>
                    `;
                }).join('');
            }
        }
        // --- END SEARCH ---


        // --- Event Listeners ---
        document.getElementById('prev-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
        document.getElementById('next-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
        
        document.getElementById('calendar').addEventListener('click', (e) => { 
            const dayEl = e.target.closest('.day');
            if (dayEl && dayEl.dataset.date) {
                loadDataForDate(dayEl.dataset.date); 
            }
        });
        
        document.querySelectorAll('input, textarea').forEach(el => el.addEventListener('input', saveData));

        // --- Data Management Listeners (Unchanged, except .ics) ---
        document.getElementById('export-json').addEventListener('click', () => {
            const dataStr = localStorage.getItem(storageKey);
            if(!dataStr) { alert('No data to export!'); return; }
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ceo_dashboard_v3.0_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        });

        document.getElementById('import-json').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        mainData = JSON.parse(e.target.result);
                        localStorage.setItem(storageKey, JSON.stringify(mainData));
                        loadDataForDate(toYMD(selectedDate));
                        alert('Data imported successfully!');
                    } catch (error) {
                        alert('Error importing file.');
                    }
                };
                reader.readAsText(file);
            }
        });
                
        document.getElementById('export-csv').addEventListener('click', exportToCsv);
        document.getElementById('import-csv').addEventListener('change', importFromCsv);
        document.getElementById('export-ics').addEventListener('click', exportToIcs); // Listener for new button

        document.getElementById('reset-data').addEventListener('click', () => {
            if (confirm('Are you sure you want to reset ALL data? This cannot be undone.')) {
                localStorage.removeItem(storageKey);
                mainData = {};
                // This will clear all inputs, including new textareas
                document.querySelectorAll('input, textarea').forEach(el => el.type === 'checkbox' ? el.checked = false : el.value = '');
                document.getElementById('filter-start-date').value = '';
                document.getElementById('filter-end-date').value = '';
                filterStartDate = null;
                filterEndDate = null;
                activeCalendarFilter = 'all';
                document.querySelector('.calendar-filter-btn.active').classList.remove('active');
                document.querySelector('.calendar-filter-btn[data-filter="all"]').classList.add('active');
                                
                loadDataForDate(toYMD(selectedDate)); // This will reload the empty state
                alert('All data has been reset.');
            }
        });

        // --- Date Filter Event Listeners (Unchanged) ---
        document.getElementById('filter-stats').addEventListener('click', () => {
            const startVal = document.getElementById('filter-start-date').value;
            const endVal = document.getElementById('filter-end-date').value;

            if (!startVal || !endVal) {
                alert('Please select both a start and end date.');
                return;
            }
            if (startVal > endVal) {
                alert('Start date cannot be after end date.');
                return;
            }

            filterStartDate = startVal;
            filterEndDate = endVal;
            calculateAndRenderStats(filterStartDate, filterEndDate);
        });

        document.getElementById('reset-filter').addEventListener('click', () => {
            document.getElementById('filter-start-date').value = '';
            document.getElementById('filter-end-date').value = '';
            filterStartDate = null;
            filterEndDate = null;
            calculateAndRenderStats(null, null);
        });
        
        // --- Calendar Filter Event Listener (Unchanged) ---
        document.getElementById('calendar-filter-controls').addEventListener('click', (e) => {
            const btn = e.target.closest('.calendar-filter-btn');
            if (btn && btn.dataset.filter) {
                document.querySelector('.calendar-filter-btn.active').classList.remove('active');
                btn.classList.add('active');
                activeCalendarFilter = btn.dataset.filter;
                renderCalendar();
            }
        });

        // --- Search Event Listeners (Unchanged) ---
        document.getElementById('search-button').addEventListener('click', performSearch);
        
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        document.getElementById('search-results').addEventListener('click', (e) => {
            const item = e.target.closest('.search-result-item');
            if (item && item.dataset.date) {
                const dateStr = item.dataset.date;
                loadDataForDate(dateStr);
                document.getElementById('daily-scorecard').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });

        // Initial Load
        mainData = JSON.parse(localStorage.getItem(storageKey)) || {};
        loadDataForDate(toYMD(selectedDate));
    });
    </script>
</body>
</html>