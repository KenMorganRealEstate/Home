<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUISE READY: MISSION CONTROL</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        missionTeal: { DEFAULT: '#008080', light: '#20B2AA', dark: '#002020' },
                        missionOrange: { DEFAULT: '#FF7F50', light: '#FFA07A', dark: '#4a1d00' },
                        missionBg: '#020408', // Darker black/blue
                        panelBg: '#0f172a'
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'scan': 'scan 8s linear infinite'
                    },
                    keyframes: {
                        scan: {
                            '0%': { backgroundPosition: '0 0' },
                            '100%': { backgroundPosition: '0 100%' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020408; font-family: 'Segoe UI', Roboto, monospace; color: #a0aec0; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #020408; }
        ::-webkit-scrollbar-thumb { background: #008080; border-radius: 2px; }
        
        /* Glass Panel with Glow */
        .glass-panel {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(0, 128, 128, 0.3);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        /* 3D Buttons */
        .btn-3d {
            transition: all 0.1s;
            border-bottom: 2px solid rgba(0,0,0,0.5);
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        .btn-3d:active {
            transform: translateY(2px);
            border-bottom: 0;
        }
        .btn-3d:hover {
            filter: brightness(1.2);
            box-shadow: 0 0 10px rgba(0, 128, 128, 0.4);
        }

        /* Inputs */
        .mission-input {
            background: rgba(0,0,0,0.6);
            border: 1px solid #1e293b;
            color: #00ffcc;
            padding: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            width: 100%;
            transition: border 0.2s;
        }
        .mission-input:focus { outline: none; border-color: #FF7F50; box-shadow: 0 0 10px rgba(255, 127, 80, 0.2); }

        /* Range Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 0; /* Square thumb for sci-fi feel */
            background: #FF7F50; cursor: pointer; margin-top: -6px; border: 1px solid #fff;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #1e293b; border: 1px solid #334155;
        }
        
        /* Mission List Item */
        .mission-item:hover { background: rgba(0, 255, 204, 0.1); }
        .mission-item.selected { border-left: 4px solid #FF7F50; background: rgba(255, 127, 80, 0.1); }

        /* CRT Scanline Effect Overlay */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 3px, 3px 100%;
            opacity: 0.6;
        }
        
        /* Chevron Button */
        .chevron-btn {
            background: rgba(0, 255, 204, 0.1);
            border: 1px solid rgba(0, 128, 128, 0.3);
            color: #00ffcc;
            padding: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .chevron-btn:hover { background: rgba(0, 255, 204, 0.3); box-shadow: 0 0 5px rgba(0,255,204,0.5); }
        .chevron-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">
    
    <!-- CRT Overlay -->
    <div class="scanlines"></div>

    <div class="w-full max-w-7xl space-y-4 p-4 relative z-10">
        
        <!-- 1. HEADER -->
        <div class="glass-panel p-4 rounded-none border-l-4 border-missionTeal relative overflow-hidden flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3 z-10 w-full md:w-auto">
                <i data-lucide="crosshair" class="w-8 h-8 text-missionTeal flex-shrink-0 animate-pulse-slow"></i> 
                <div class="flex-grow">
                    <div class="text-[10px] font-bold text-missionTeal uppercase tracking-[0.2em]">CURRENT MISSION PROTOCOL</div>
                    <select id="missionSelector" onchange="switchMission()" onmouseenter="AudioEngine.playHover()" class="w-full md:w-auto bg-transparent font-black text-xl md:text-3xl text-white uppercase tracking-widest outline-none cursor-pointer hover:text-missionOrange transition border-b border-transparent hover:border-missionOrange/50 pb-1 font-mono">
                        <!-- Options populated by JS -->
                    </select>
                </div>
            </div>

            <div class="flex items-center gap-2 z-10">
                <!-- Audio Toggle -->
                <button onclick="toggleAudio()" id="audioBtn" onmouseenter="AudioEngine.playHover()" class="btn-3d bg-black/60 hover:bg-black/80 text-missionTeal p-3 border border-missionTeal/30" title="Toggle HUD Audio">
                    <i data-lucide="volume-2" class="w-5 h-5"></i>
                </button>
                
                <button onclick="toggleMissionManager()" onmouseenter="AudioEngine.playHover()" class="btn-3d bg-black/60 hover:bg-black/80 text-missionTeal text-xs font-bold py-3 px-6 border border-missionTeal/30 flex items-center gap-2 transition font-mono">
                    <i data-lucide="settings"></i> CONFIG
                </button>
            </div>
        </div>

        <!-- 1.5 MISSION MANAGER (Hidden) -->
        <div id="missionManager" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
            <div class="glass-panel w-full max-w-4xl border-t-4 border-missionOrange bg-[#050a10] flex flex-col max-h-[90vh]">
                <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-missionOrange flex items-center gap-2 font-mono"><i data-lucide="database"></i> MISSION DATABASE</h2>
                    <button onclick="toggleMissionManager()" class="text-gray-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="flex flex-col md:flex-row flex-grow overflow-hidden">
                    <!-- List -->
                    <div class="w-full md:w-1/3 border-r border-gray-800 flex flex-col bg-black/40">
                        <div class="p-3 bg-gray-900 text-[10px] font-bold text-missionTeal uppercase tracking-wider">Stored Profiles</div>
                        <div id="missionListContainer" class="flex-grow overflow-y-auto p-2 space-y-1 font-mono"></div>
                        <div class="p-4 border-t border-gray-800">
                            <button onclick="prepareCreateNew()" onmouseenter="AudioEngine.playHover()" class="w-full btn-3d bg-missionTeal/20 hover:bg-missionTeal/40 text-missionTeal border border-missionTeal/50 font-bold py-3 flex items-center justify-center gap-2 text-xs font-mono">
                                <i data-lucide="plus-square" class="w-4 h-4"></i> INIT NEW
                            </button>
                        </div>
                    </div>
                    <!-- Editor -->
                    <div class="w-full md:w-2/3 p-6 overflow-y-auto bg-[#0a0f1a]">
                        <h3 class="text-missionOrange font-bold text-xs uppercase mb-6 border-b border-gray-800 pb-2" id="editorTitle">Parameters</h3>
                        <input type="hidden" id="editId">
                        <div class="space-y-6">
                            <div>
                                <label class="text-[10px] font-bold text-gray-500 uppercase mb-1 block">Operation Name</label>
                                <input type="text" id="editName" class="mission-input text-lg font-bold text-white" placeholder="OPERATION ALPHA">
                            </div>
                            <div class="grid grid-cols-2 gap-6">
                                <div><label class="text-[10px] font-bold text-gray-500 uppercase mb-1 block">T-Minus Start</label><input type="date" id="editStart" class="mission-input"></div>
                                <div><label class="text-[10px] font-bold text-gray-500 uppercase mb-1 block">T-Minus End</label><input type="date" id="editEnd" class="mission-input"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-6">
                                <div><label class="text-[10px] font-bold text-gray-500 uppercase mb-1 block">Mass Start</label><input type="number" id="editStartW" step="0.1" class="mission-input text-missionOrange"></div>
                                <div><label class="text-[10px] font-bold text-gray-500 uppercase mb-1 block">Mass Target</label><input type="number" id="editGoalW" step="0.1" class="mission-input text-missionTeal"></div>
                            </div>
                        </div>
                        <div class="mt-8 flex gap-3">
                            <button onclick="saveMissionFromEditor()" onmouseenter="AudioEngine.playHover()" class="flex-1 btn-3d bg-missionTeal hover:bg-missionTeal-light text-black font-bold py-3 font-mono">SAVE</button>
                            <button onclick="loadMissionFromEditor()" onmouseenter="AudioEngine.playHover()" class="flex-1 btn-3d bg-blue-900 hover:bg-blue-800 text-blue-200 border border-blue-700 font-bold py-3 font-mono">LOAD</button>
                            <button onclick="deleteMissionFromEditor()" onmouseenter="AudioEngine.playHover()" class="btn-3d bg-red-900/50 hover:bg-red-900 text-red-400 border border-red-800 font-bold py-3 px-4"><i data-lucide="trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. DASHBOARD ROW: TIMERS & RANK -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Countdown -->
            <div class="glass-panel p-4 flex flex-col justify-center items-center bg-black/40 border-t-2 border-missionTeal">
                <div class="flex gap-4 text-center font-mono">
                    <div><span id="cnt-days" class="text-4xl font-bold text-white">00</span><div class="text-[10px] text-missionTeal">DAYS</div></div>
                    <div class="text-4xl font-bold text-gray-700">:</div>
                    <div><span id="cnt-hours" class="text-4xl font-bold text-white">00</span><div class="text-[10px] text-missionTeal">HRS</div></div>
                    <div class="text-4xl font-bold text-gray-700">:</div>
                    <div><span id="cnt-mins" class="text-4xl font-bold text-white">00</span><div class="text-[10px] text-missionTeal">MIN</div></div>
                </div>
            </div>

            <!-- Rank & Progress -->
            <div class="md:col-span-2 glass-panel p-6 bg-black/40 border-t-2 border-missionOrange flex flex-col justify-center relative overflow-hidden">
                <!-- Rank Display -->
                <div class="absolute top-2 right-4 text-right z-10">
                    <div class="text-[10px] text-gray-500 uppercase tracking-widest">CURRENT RANK</div>
                    <div id="rank-display" class="text-2xl font-black text-white italic tracking-wider drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">RECRUIT</div>
                </div>

                <div class="flex justify-between mb-2 text-xs font-bold font-mono z-10 relative mt-4">
                    <span class="text-gray-500">START: <span id="disp-start-weight" class="text-white">--</span></span>
                    <span class="text-missionOrange">TARGET: <span id="disp-goal-weight" class="text-white">--</span></span>
                </div>
                
                <!-- Sci-Fi Progress Bar -->
                <div class="h-6 bg-[#0a0f1a] border border-gray-700 relative shadow-[inset_0_0_10px_rgba(0,0,0,0.8)]">
                    <!-- Fill -->
                    <div id="progress-fill" class="h-full bg-gradient-to-r from-missionTeal-dark via-missionTeal to-white transition-all duration-1000 relative overflow-hidden" style="width: 0%">
                        <div class="absolute top-0 left-0 w-full h-full bg-[url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAIklEQVQIW2NkQAKrVq36zwjjgzhhYWGMYAEYB8RmROaABADeOQ8CXl/xfgAAAABJRU5ErkJggg==')] opacity-20"></div>
                    </div>
                    <!-- Text Overlay -->
                    <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center">
                        <span id="progress-text" class="text-xs font-bold text-white mix-blend-difference font-mono">CALCULATING...</span>
                    </div>
                    <!-- Pacer -->
                    <div id="pace-marker" class="absolute top-0 h-full w-1 bg-missionOrange shadow-[0_0_15px_#FF7F50] z-20 opacity-80" style="left: 0%"></div>
                </div>
            </div>
        </div>

        <!-- 3. MAIN GRID -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
            
            <!-- LEFT COL: INPUTS -->
            <div class="lg:col-span-4 space-y-4">
                <div class="glass-panel">
                    <div class="bg-missionTeal/10 p-2 flex justify-between px-4 border-b border-missionTeal/20">
                        <span class="text-xs font-bold text-missionTeal uppercase tracking-widest">Daily Log</span>
                        <i data-lucide="pen-tool" class="w-3 h-3 text-missionTeal"></i>
                    </div>
                    <div class="p-4 space-y-4">
                        <div class="flex gap-3">
                            <div class="flex-1">
                                <label class="text-[10px] font-bold text-gray-500 block mb-1">DATE</label>
                                <div class="flex items-center gap-1">
                                    <button type="button" onclick="adjustDate('inpDate', -1)" onmouseenter="AudioEngine.playHover()" class="chevron-btn rounded"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                                    <input type="date" id="inpDate" class="mission-input text-xs">
                                    <button type="button" onclick="adjustDate('inpDate', 1)" onmouseenter="AudioEngine.playHover()" class="chevron-btn rounded"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                            <div class="flex-1">
                                <label class="text-[10px] font-bold text-gray-500 block mb-1">WEIGHT</label>
                                <input type="number" id="inpWeight" step="0.1" class="mission-input text-center font-bold text-xl text-white border-missionOrange/50 focus:border-missionOrange" placeholder="000.0">
                            </div>
                        </div>
                        
                        <!-- Vibe Slider -->
                        <div>
                            <div class="flex justify-between text-[10px] font-bold text-gray-500 mb-1">
                                <span>VIBE CHECK</span>
                                <span id="mood-val-display" class="text-missionOrange">5/10</span>
                            </div>
                            <input type="range" id="inpMood" min="1" max="10" value="5" class="w-full" oninput="handleMoodChange(this.value)">
                        </div>

                        <!-- Habits Grid -->
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="toggleHabit('carnivore')" onmouseenter="AudioEngine.playHover()" id="h-carnivore" class="p-3 bg-black/40 border border-gray-700 hover:border-missionTeal transition flex justify-between items-center group">
                                <span class="text-[10px] font-bold text-gray-400 group-[.active]:text-white">ü•© CARNIVORE</span>
                                <span class="status-icon text-gray-600 text-[10px]">OFF</span>
                            </button>
                            <button onclick="toggleHabit('walk')" onmouseenter="AudioEngine.playHover()" id="h-walk" class="p-3 bg-black/40 border border-gray-700 hover:border-missionTeal transition flex justify-between items-center group">
                                <span class="text-[10px] font-bold text-gray-400 group-[.active]:text-white">üö∂ WALK</span>
                                <span class="status-icon text-gray-600 text-[10px]">OFF</span>
                            </button>
                            <button onclick="toggleHabit('lift')" onmouseenter="AudioEngine.playHover()" id="h-lift" class="p-3 bg-black/40 border border-gray-700 hover:border-missionTeal transition flex justify-between items-center group">
                                <span class="text-[10px] font-bold text-gray-400 group-[.active]:text-white">üèãÔ∏è LIFT</span>
                                <span class="status-icon text-gray-600 text-[10px]">OFF</span>
                            </button>
                            <button onclick="toggleHabit('alcohol')" onmouseenter="AudioEngine.playHover()" id="h-alcohol" class="p-3 bg-black/40 border border-gray-700 hover:border-missionOrange transition flex justify-between items-center group active">
                                <span class="text-[10px] font-bold text-gray-400 group-[.active]:text-white">üö´ ZERO ALC</span>
                                <span class="status-icon text-missionOrange text-[10px]">ON</span>
                            </button>
                        </div>
                        
                        <input type="text" id="inpNotes" class="mission-input text-xs" placeholder="Tactical Notes...">
                    </div>
                </div>

                <!-- DISCIPLINE BARS (Restored) -->
                <div class="glass-panel p-4 border-l-2 border-missionTeal bg-black/20">
                    <h3 class="text-[10px] font-bold text-gray-500 uppercase mb-3 tracking-widest">Discipline Matrix</h3>
                    <div class="space-y-3">
                        <div><div class="flex justify-between text-[10px] mb-1"><span class="text-missionTeal">CARNIVORE</span><span id="stat-c-val" class="text-white">0%</span></div><div class="h-1 bg-gray-800 w-full"><div id="bar-c" class="h-full bg-missionTeal w-0 transition-all duration-500"></div></div></div>
                        <div><div class="flex justify-between text-[10px] mb-1"><span class="text-missionTeal">WALKING</span><span id="stat-w-val" class="text-white">0%</span></div><div class="h-1 bg-gray-800 w-full"><div id="bar-w" class="h-full bg-missionTeal w-0 transition-all duration-500"></div></div></div>
                        <div><div class="flex justify-between text-[10px] mb-1"><span class="text-missionTeal">LIFTING</span><span id="stat-l-val" class="text-white">0%</span></div><div class="h-1 bg-gray-800 w-full"><div id="bar-l" class="h-full bg-missionTeal w-0 transition-all duration-500"></div></div></div>
                        <div><div class="flex justify-between text-[10px] mb-1"><span class="text-missionOrange">ZERO ALCOHOL</span><span id="stat-a-val" class="text-white">0%</span></div><div class="h-1 bg-gray-800 w-full"><div id="bar-a" class="h-full bg-missionOrange w-0 transition-all duration-500"></div></div></div>
                    </div>
                </div>
                
                <!-- ANALYTICS -->
                <div class="glass-panel p-4 border-l-2 border-missionOrange bg-black/20 font-mono text-xs">
                    <div class="flex justify-between mb-2"><span class="text-gray-500">LOSS RATE</span><span id="stat-rate" class="text-white font-bold">--</span></div>
                    <div class="flex justify-between mb-2"><span class="text-gray-500">FORECAST</span><span id="stat-projected" class="text-white font-bold">--</span></div>
                    <div class="flex justify-between mb-2"><span class="text-gray-500">AVG VIBE</span><span id="stat-mood" class="text-white font-bold">--</span></div>
                    <div id="forecast-msg" class="mt-3 text-center p-2 bg-black/40 text-gray-400 border border-gray-800">AWAITING DATA</div>
                </div>
            </div>

            <!-- RIGHT COL: GRAPH & VISUALS -->
            <div class="lg:col-span-8 space-y-4">
                <div class="flex justify-end items-center gap-2 mb-2">
                    <span class="text-[10px] text-gray-500 font-bold uppercase">DATA FILTER:</span>
                    <div class="flex items-center gap-1">
                        <button type="button" onclick="adjustDate('filterStart', -1)" onmouseenter="AudioEngine.playHover()" class="chevron-btn rounded-l"><i data-lucide="chevron-left" class="w-3 h-3"></i></button>
                        <input type="date" id="filterStart" onchange="applyFilter()" class="bg-black/50 border-y border-gray-700 text-white text-xs p-1 w-24 font-mono text-center">
                        <button type="button" onclick="adjustDate('filterStart', 1)" onmouseenter="AudioEngine.playHover()" class="chevron-btn rounded-r"><i data-lucide="chevron-right" class="w-3 h-3"></i></button>
                    </div>
                    <span class="text-gray-600 text-[10px]">-</span>
                    <div class="flex items-center gap-1">
                        <button type="button" onclick="adjustDate('filterEnd', -1)" onmouseenter="AudioEngine.playHover()" class="chevron-btn rounded-l"><i data-lucide="chevron-left" class="w-3 h-3"></i></button>
                        <input type="date" id="filterEnd" onchange="applyFilter()" class="bg-black/50 border-y border-gray-700 text-white text-xs p-1 w-24 font-mono text-center">
                        <button type="button" onclick="adjustDate('filterEnd', 1)" onmouseenter="AudioEngine.playHover()" class="chevron-btn rounded-r"><i data-lucide="chevron-right" class="w-3 h-3"></i></button>
                    </div>
                    <button onclick="resetFilter()" onmouseenter="AudioEngine.playHover()" class="bg-missionTeal/20 hover:bg-missionTeal/40 text-missionTeal text-[10px] font-bold py-1 px-2 border border-missionTeal/30 ml-2">RESET</button>
                </div>

                <div class="glass-panel p-2 h-[350px] relative">
                    <canvas id="weightChart"></canvas>
                </div>

                <!-- Visual Programming -->
                <div class="glass-panel relative border-t-2 border-missionOrange overflow-hidden group h-[280px]">
                    <div class="absolute top-0 left-0 w-full p-2 z-10 flex justify-between bg-gradient-to-b from-black/90 to-transparent">
                        <span class="text-[10px] font-bold text-missionOrange uppercase tracking-widest">VISUAL PROGRAMMING</span>
                        <button onclick="cycleFearImage()" class="text-gray-400 hover:text-white"><i data-lucide="refresh-ccw" class="w-4 h-4"></i></button>
                    </div>
                    <div class="fear-img-container w-full h-full">
                        <img id="fear-img" src="" class="w-full h-full object-cover opacity-70 group-hover:opacity-90 transition-opacity duration-500">
                    </div>
                    <div class="absolute bottom-0 left-0 w-full p-4 z-20 bg-gradient-to-t from-black via-black/80 to-transparent">
                        <p id="fear-quote" class="text-white font-mono text-sm mb-2 italic">"..."</p>
                        <div class="flex justify-between items-end">
                            <span id="quote-author" class="text-missionOrange text-xs font-bold"></span>
                            <a href="https://photos.app.goo.gl/HBVGGen5bt1LmQYo8" target="_blank" onmouseenter="AudioEngine.playHover()" class="bg-missionOrange text-black text-[10px] font-bold py-1 px-3 flex items-center gap-1 hover:bg-white transition">
                                <i data-lucide="external-link" class="w-3 h-3"></i> ALBUM
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. FOOTER CONTROLS -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
            <button onclick="syncGoogle()" onmouseenter="AudioEngine.playHover()" class="md:col-span-2 btn-3d bg-blue-900 hover:bg-blue-800 text-blue-100 border border-blue-700 py-3 font-mono font-bold text-xs">SYNC G-CALENDAR</button>
            <button onclick="exportFullICS()" onmouseenter="AudioEngine.playHover()" class="btn-3d bg-gray-800 hover:bg-gray-700 text-white border border-gray-600 py-3 font-mono font-bold text-xs">EXPORT .ICS</button>
            <button onclick="exportJSON()" onmouseenter="AudioEngine.playHover()" class="btn-3d bg-gray-800 hover:bg-gray-700 text-white border border-gray-600 py-3 font-mono font-bold text-xs">BACKUP JSON</button>
            <button onclick="exportCSV()" onmouseenter="AudioEngine.playHover()" class="btn-3d bg-gray-800 hover:bg-gray-700 text-white border border-gray-600 py-3 font-mono font-bold text-xs">EXPORT .CSV</button>
            <label class="btn-3d bg-gray-800 hover:bg-gray-700 text-white border border-gray-600 py-3 font-mono font-bold text-xs flex justify-center items-center cursor-pointer" onmouseenter="AudioEngine.playHover()">
                RESTORE JSON <input type="file" onchange="importJSON(this)" class="hidden">
            </label>
        </div>

    </div>

    <script>
        // --- SCI-FI AUDIO ENGINE ---
        const AudioEngine = {
            ctx: null,
            muted: false,
            
            init() {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
            },

            playTone(freq, type, duration, vol=0.1) {
                if(this.muted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },

            playChirp() { 
                if(this.muted || !this.ctx) return;
                this.playTone(1500, 'sine', 0.05, 0.05);
            },
            
            playHover() {
                if(this.muted || !this.ctx) return;
                this.playTone(80, 'square', 0.02, 0.02); // Subtle low click
            },

            playVibe(val) {
                if(this.muted || !this.ctx) return;
                const freq = 200 + (val * 120); 
                this.playTone(freq, 'triangle', 0.1, 0.05);
            },

            playPowerUp() { // For leveling up rank
                if(this.muted || !this.ctx) return;
                const now = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'square';
                osc.frequency.setValueAtTime(440, now);
                osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
                osc.frequency.exponentialRampToValueAtTime(1760, now + 0.3);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.6);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(now + 0.6);
            },
            
            playDataSweep() { // Save/Load/Export
                if(this.muted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.setValueAtTime(200, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(800, this.ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.3);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.3);
            },

            playStatic() {
                if(this.muted || !this.ctx) return;
                const bufferSize = this.ctx.sampleRate * 0.15;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                const gain = this.ctx.createGain();
                gain.gain.value = 0.03;
                noise.connect(gain);
                gain.connect(this.ctx.destination);
                noise.start();
            }
        };

        function toggleAudio() {
            if(!AudioEngine.ctx) AudioEngine.init();
            AudioEngine.muted = !AudioEngine.muted;
            const btn = document.getElementById('audioBtn');
            if(AudioEngine.muted) {
                btn.classList.add('text-red-500', 'border-red-500');
                btn.innerHTML = '<i data-lucide="volume-x" class="w-5 h-5"></i>';
            } else {
                btn.classList.remove('text-red-500', 'border-red-500');
                btn.innerHTML = '<i data-lucide="volume-2" class="w-5 h-5"></i>';
                AudioEngine.playChirp();
            }
            lucide.createIcons();
        }

        // --- CONSTANTS ---
        const IMAGE_LIB = [
            "https://github.com/KenMorganRealEstate/Home/blob/main/111.png?raw=true",
            "https://github.com/KenMorganRealEstate/Home/blob/main/222.png?raw=true",
            "https://github.com/KenMorganRealEstate/Home/blob/main/333.png?raw=true",
            "https://github.com/KenMorganRealEstate/Home/blob/main/444.png?raw=true",
            "https://github.com/KenMorganRealEstate/Home/blob/main/555.png?raw=true"
        ];

        const QUOTES = [
            {t: "The buffet line sees everything.", a: "Reality Check"},
            {t: "Discipline is choosing what you want most over what you want now.", a: "Unknown"},
            {t: "A goal is a dream with a deadline.", a: "Napoleon Hill"},
            {t: "Do not negotiate with weakness.", a: "Unknown"},
            {t: "The ship leaves with or without your abs.", a: "Reality"},
            {t: "Success is not final, failure is not fatal.", a: "Winston Churchill"}
        ];

        const RANKS = [
            {pct: 0, title: "RECRUIT"},
            {pct: 20, title: "GUARDIAN"},
            {pct: 40, title: "VANGUARD"},
            {pct: 60, title: "TITAN"},
            {pct: 80, title: "WARLORD"},
            {pct: 100, title: "LEGEND"}
        ];

        // --- APP STATE ---
        let appState = {
            entries: [],
            missions: [],
            activeMissionId: null,
            filter: { start: null, end: null },
            currentEntry: { carnivore: false, walk: false, lift: false, alcohol: true, mood: 5 },
            imgIndex: 0,
            lastRankIndex: 0
        };

        const DEFAULT_MISSION = {
            id: 1,
            name: "CRUISE PREP",
            start: "2025-11-21",
            end: "2026-02-01",
            startW: 201.6,
            goalW: 175.0
        };

        // --- INIT ---
        window.onload = () => {
            lucide.createIcons();
            initCharts(); 
            loadData();
            startCountdown();
            cycleFearImage();
            
            document.body.addEventListener('click', () => { if(!AudioEngine.ctx) AudioEngine.init(); }, {once:true});
            
            // Set default dates
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('inpDate').value = todayStr;
            
            // Set default filter dates based on active mission
            const m = getActiveMission();
            document.getElementById('filterStart').value = m.start;
            document.getElementById('filterEnd').value = m.end;
            
            loadEntryForDate(todayStr);

            document.getElementById('inpWeight').addEventListener('input', saveEntry);
            document.getElementById('inpNotes').addEventListener('input', saveEntry);
            document.getElementById('inpDate').addEventListener('change', (e) => loadEntryForDate(e.target.value));
        };

        function handleMoodChange(val) {
            document.getElementById('mood-val-display').innerText = val + '/10';
            AudioEngine.playVibe(val);
            saveEntry();
        }
        
        function adjustDate(id, days) {
            const input = document.getElementById(id);
            let currentDate;
            
            if(!input.value) {
                // If no date is set, use today
                currentDate = new Date();
            } else {
                currentDate = new Date(input.value);
            }
            
            // Adjust the date
            currentDate.setDate(currentDate.getDate() + days);
            
            // Format as YYYY-MM-DD
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const day = String(currentDate.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;
            
            // Update the input
            input.value = formattedDate;
            
            AudioEngine.playChirp();
            
            // Trigger appropriate actions based on which input was changed
            if(id === 'inpDate') {
                loadEntryForDate(formattedDate);
            } else if(id === 'filterStart' || id === 'filterEnd') {
                applyFilter();
            }
        }

        // --- DATA ---
        function loadData() {
            const savedEntries = localStorage.getItem('cruiseMissionData');
            const savedMissions = localStorage.getItem('cruiseMissionGoals');
            const savedActiveId = localStorage.getItem('cruiseMissionActiveId');

            appState.entries = savedEntries ? JSON.parse(savedEntries) : [];
            appState.missions = savedMissions ? JSON.parse(savedMissions) : [JSON.parse(JSON.stringify(DEFAULT_MISSION))];
            
            // Set Active ID safely
            const found = appState.missions.find(m => m.id === parseInt(savedActiveId));
            appState.activeMissionId = found ? found.id : appState.missions[0].id;

            populateMissionSelector();
            loadMissionParams();
        }

        function saveData(silent=false) {
            localStorage.setItem('cruiseMissionData', JSON.stringify(appState.entries));
            localStorage.setItem('cruiseMissionGoals', JSON.stringify(appState.missions));
            localStorage.setItem('cruiseMissionActiveId', appState.activeMissionId);
            if(!silent && !AudioEngine.muted && AudioEngine.ctx) AudioEngine.playChirp();
        }

        // --- MISSION LOGIC ---
        function getActiveMission() {
            return appState.missions.find(m => m.id === appState.activeMissionId) || DEFAULT_MISSION;
        }

        function populateMissionSelector() {
            const sel = document.getElementById('missionSelector');
            sel.innerHTML = '';
            appState.missions.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.innerText = m.name;
                opt.selected = m.id === appState.activeMissionId;
                opt.className = "bg-black text-white";
                sel.appendChild(opt);
            });
        }

        function switchMission() {
            const newId = parseInt(document.getElementById('missionSelector').value);
            appState.activeMissionId = newId;
            loadMissionParams();
            saveData(true);
            refreshUI();
        }

        function loadMissionParams() {
            const m = getActiveMission();
            document.getElementById('editId').value = m.id;
            document.getElementById('editName').value = m.name;
            document.getElementById('editStart').value = m.start;
            document.getElementById('editEnd').value = m.end;
            document.getElementById('editStartW').value = m.startW;
            document.getElementById('editGoalW').value = m.goalW;
            
            document.getElementById('editorTitle').innerText = "EDIT ACTIVE MISSION";
            
            resetFilter();
            renderMissionList();
        }

        function saveMissionFromEditor() {
            const idVal = document.getElementById('editId').value;
            const name = document.getElementById('editName').value;
            if(!name) return alert("Name Required");

            const config = {
                name: name.toUpperCase(),
                start: document.getElementById('editStart').value,
                end: document.getElementById('editEnd').value,
                startW: parseFloat(document.getElementById('editStartW').value),
                goalW: parseFloat(document.getElementById('editGoalW').value)
            };

            if(idVal === "NEW") {
                // APPEND NEW
                const newId = Date.now();
                appState.missions.push({id: newId, ...config});
                appState.activeMissionId = newId;
                alert("NEW MISSION INITIALIZED");
            } else {
                // UPDATE EXISTING
                const idx = appState.missions.findIndex(m => m.id === parseInt(idVal));
                if(idx > -1) appState.missions[idx] = {...appState.missions[idx], ...config};
                alert("MISSION PARAMS UPDATED");
            }
            
            saveData(true);
            populateMissionSelector();
            renderMissionList();
            loadMissionParams();
            refreshUI();
        }

        function prepareCreateNew() {
            document.getElementById('editId').value = "NEW";
            document.getElementById('editName').value = "";
            document.getElementById('editStart').value = new Date().toISOString().split('T')[0];
            document.getElementById('editEnd').value = "";
            document.getElementById('editStartW').value = "";
            document.getElementById('editGoalW').value = "";
            document.getElementById('editorTitle').innerText = "INITIALIZE NEW MISSION";
            renderMissionList();
        }

        function loadMissionFromEditor() {
            const idVal = document.getElementById('editId').value;
            if(idVal === "NEW") return alert("Save first.");
            appState.activeMissionId = parseInt(idVal);
            saveData(true);
            populateMissionSelector();
            loadMissionParams();
            refreshUI();
        }

        function deleteMissionFromEditor() {
            const idVal = document.getElementById('editId').value;
            if(idVal === "NEW") return;
            if(appState.missions.length <= 1) return alert("Cannot delete last mission.");
            
            if(confirm("DELETE MISSION?")) {
                appState.missions = appState.missions.filter(m => m.id !== parseInt(idVal));
                if(appState.activeMissionId === parseInt(idVal)) appState.activeMissionId = appState.missions[0].id;
                saveData(true);
                populateMissionSelector();
                renderMissionList();
                loadMissionParams();
                refreshUI();
            }
        }

        function toggleMissionManager() {
            const el = document.getElementById('missionManager');
            el.classList.toggle('hidden');
            if(!el.classList.contains('hidden')) {
                renderMissionList();
                loadMissionParams();
            }
        }

        function renderMissionList() {
            const container = document.getElementById('missionListContainer');
            container.innerHTML = '';
            const editId = document.getElementById('editId').value;
            
            appState.missions.forEach(m => {
                const div = document.createElement('div');
                const isEditing = (m.id == editId);
                const isActive = (m.id === appState.activeMissionId);
                
                div.className = `mission-item p-2 rounded cursor-pointer border flex justify-between items-center ${isEditing ? 'border-missionOrange bg-missionOrange/10' : 'border-transparent'}`;
                div.innerHTML = `<span class="${isActive ? 'text-white font-bold' : 'text-gray-400'}">${m.name}</span>`;
                div.onclick = () => loadMissionToEditor(m.id);
                container.appendChild(div);
            });
        }

        function loadMissionToEditor(id) {
            const m = appState.missions.find(x => x.id === id);
            if(!m) return;
            document.getElementById('editId').value = m.id;
            document.getElementById('editName').value = m.name;
            document.getElementById('editStart').value = m.start;
            document.getElementById('editEnd').value = m.end;
            document.getElementById('editStartW').value = m.startW;
            document.getElementById('editGoalW').value = m.goalW;
            document.getElementById('editorTitle').innerText = "EDIT: " + m.name;
            renderMissionList();
        }

        // --- LOGIC ---
        function applyFilter() {
            appState.filter.start = document.getElementById('filterStart').value;
            appState.filter.end = document.getElementById('filterEnd').value;
            refreshUI();
        }
        function resetFilter() {
            const m = getActiveMission();
            appState.filter.start = m.start;
            appState.filter.end = m.end;
            document.getElementById('filterStart').value = m.start;
            document.getElementById('filterEnd').value = m.end;
            refreshUI();
        }
        function refreshUI() {
            updateDeepStats();
            updateCharts();
            updateRankAndProgress();
            startCountdown();
        }

        function loadEntryForDate(date) {
            const entry = appState.entries.find(e => e.date === date);
            if(entry) {
                document.getElementById('inpWeight').value = entry.weight;
                document.getElementById('inpNotes').value = entry.notes || "";
                document.getElementById('inpMood').value = entry.mood || 5;
                document.getElementById('mood-val-display').innerText = (entry.mood||5)+'/10';
                appState.currentEntry = {...entry};
            } else {
                // find last weight
                const sorted = [...appState.entries].sort((a,b) => new Date(a.date)-new Date(b.date));
                const last = sorted[sorted.length-1];
                document.getElementById('inpWeight').value = last ? last.weight : "";
                document.getElementById('inpNotes').value = "";
                document.getElementById('inpMood').value = 5;
                document.getElementById('mood-val-display').innerText = "5/10";
                appState.currentEntry = {carnivore:false, walk:false, lift:false, alcohol:true, mood:5};
            }
            renderChecklist();
        }

        function saveEntry() {
            const date = document.getElementById('inpDate').value;
            const weight = parseFloat(document.getElementById('inpWeight').value);
            if(!date) return;
            
            const newEntry = {
                date: date,
                weight: weight || null,
                notes: document.getElementById('inpNotes').value,
                mood: document.getElementById('inpMood').value,
                ...appState.currentEntry
            };
            
            appState.entries = appState.entries.filter(e => e.date !== date);
            appState.entries.push(newEntry);
            appState.entries.sort((a,b) => new Date(a.date)-new Date(b.date));
            
            saveData(true);
            refreshUI();
        }

        function toggleHabit(k) {
            appState.currentEntry[k] = !appState.currentEntry[k];
            AudioEngine.playChirp();
            saveEntry();
            renderChecklist();
        }

        function renderChecklist() {
            const update = (id, active, isAlc) => {
                const el = document.getElementById('h-'+id);
                const icon = el.querySelector('.status-icon');
                if(active) {
                    el.classList.add('bg-missionTeal/20', 'border-missionTeal');
                    if(isAlc) { el.classList.replace('border-missionTeal','border-missionOrange'); el.classList.replace('bg-missionTeal/20','bg-missionOrange/20'); }
                    el.classList.remove('bg-black/40', 'border-gray-700');
                    icon.innerText = "ON";
                } else {
                    el.classList.remove('bg-missionTeal/20', 'border-missionTeal', 'border-missionOrange', 'bg-missionOrange/20');
                    el.classList.add('bg-black/40', 'border-gray-700');
                    icon.innerText = "OFF";
                }
            };
            update('carnivore', appState.currentEntry.carnivore, false);
            update('walk', appState.currentEntry.walk, false);
            update('lift', appState.currentEntry.lift, false);
            update('alcohol', appState.currentEntry.alcohol, true);
        }

        function getFilteredEntries() {
            const s = new Date(appState.filter.start);
            const e = new Date(appState.filter.end);
            return appState.entries.filter(x => { 
                const d = new Date(x.date);
                return d >= s && d <= e;
            }).sort((a,b)=>new Date(a.date)-new Date(b.date));
        }

        function updateDeepStats() {
            const filtered = getFilteredEntries();
            const wEntries = filtered.filter(e => e.weight);
            const mission = getActiveMission();

            // Discipline Bars
            if(filtered.length > 0) {
                const t = filtered.length;
                const setBar = (id, cnt) => {
                    const pct = Math.round((cnt/t)*100);
                    document.getElementById('stat-'+id+'-val').innerText = pct+'%';
                    document.getElementById('bar-'+id).style.width = pct+'%';
                };
                setBar('c', filtered.filter(e=>e.carnivore).length);
                setBar('w', filtered.filter(e=>e.walk).length);
                setBar('l', filtered.filter(e=>e.lift).length);
                setBar('a', filtered.filter(e=>e.alcohol).length);
                
                const sumMood = filtered.reduce((a,b)=>a+(parseInt(b.mood)||5),0);
                document.getElementById('stat-mood').innerText = (sumMood/t).toFixed(1)+"/10";
            }

            // Projection
            if(wEntries.length < 2) {
                document.getElementById('stat-rate').innerText = "NEED DATA";
                document.getElementById('forecast-msg').innerText = "AWAITING DATA...";
                return;
            }
            
            const first = wEntries[0];
            const last = wEntries[wEntries.length-1];
            const d1 = new Date(first.date); d1.setHours(0,0,0,0);
            const d2 = new Date(last.date); d2.setHours(0,0,0,0);
            const days = (d2-d1)/86400000;
            
            if(days <= 0) return;
            
            const rate = (first.weight - last.weight) / days;
            const today = new Date(); today.setHours(0,0,0,0);
            const end = new Date(mission.end); end.setHours(0,0,0,0);
            const daysLeft = (end-today)/86400000;
            const proj = last.weight - (rate * daysLeft);
            const diff = proj - mission.goalW;
            
            document.getElementById('stat-rate').innerText = rate.toFixed(2) + " lbs/day";
            document.getElementById('stat-projected').innerText = proj.toFixed(1) + " lbs";
            
            const msgEl = document.getElementById('forecast-msg');
            if(diff <= 0) {
                msgEl.innerText = "TRAJECTORY OPTIMAL. PROJECTED SUCCESS.";
                msgEl.className = "mt-3 text-center p-2 bg-missionTeal/20 text-missionTeal border border-missionTeal";
            } else {
                msgEl.innerText = `WARNING: PROJECTED FAILURE BY ${diff.toFixed(1)} LBS. INCREASE EFFORT.`;
                msgEl.className = "mt-3 text-center p-2 bg-missionOrange/20 text-missionOrange border border-missionOrange animate-pulse";
            }
        }

        function updateRankAndProgress() {
            const m = getActiveMission();
            const wEntries = appState.entries.filter(e => e.weight).sort((a,b)=>new Date(a.date)-new Date(b.date));
            const curr = wEntries.length > 0 ? wEntries[wEntries.length-1].weight : m.startW;
            
            const totalLoss = m.startW - m.goalW;
            const currentLoss = m.startW - curr;
            let pct = (currentLoss / totalLoss) * 100;
            
            document.getElementById('disp-start-weight').innerText = m.startW;
            document.getElementById('disp-goal-weight').innerText = m.goalW;
            
            document.getElementById('progress-fill').style.width = Math.max(0, Math.min(100, pct)) + '%';
            document.getElementById('progress-text').innerText = `${curr} lbs / ${m.goalW} lbs (${pct.toFixed(1)}%)`;
            
            // Time Pacer
            const s = new Date(m.start).getTime();
            const e = new Date(m.end).getTime();
            const n = new Date().getTime();
            let timePct = ((n-s)/(e-s))*100;
            document.getElementById('pace-marker').style.left = Math.max(0, Math.min(100, timePct)) + '%';
            
            // RANK LOGIC
            let currentRank = "RECRUIT";
            for(let r of RANKS) {
                if(pct >= r.pct) currentRank = r.title;
            }
            
            const rankEl = document.getElementById('rank-display');
            // Check for level up
            if(rankEl.innerText !== currentRank && rankEl.innerText !== "LOADING...") {
                AudioEngine.playPowerUp(); // SOUND!
            }
            rankEl.innerText = currentRank;
        }

        function startCountdown() {
            const m = getActiveMission();
            const tick = () => {
                const diff = new Date(m.end) - new Date();
                if(diff < 0) return;
                document.getElementById('cnt-days').innerText = Math.floor(diff/86400000);
                document.getElementById('cnt-hours').innerText = Math.floor((diff%86400000)/3600000);
                document.getElementById('cnt-mins').innerText = Math.floor((diff%3600000)/60000);
            };
            tick();
            if(window.timerId) clearInterval(window.timerId);
            window.timerId = setInterval(tick, 60000);
        }

        // --- CHART ---
        let chart;
        function initCharts() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#4a5568', maxTicksLimit: 6 } },
                        y: { grid: { color: '#1e293b' }, ticks: { color: '#a0aec0' } }
                    }
                }
            });
        }

        function updateCharts() {
            if(!chart) return;
            const start = new Date(appState.filter.start);
            const end = new Date(appState.filter.end);
            const m = getActiveMission();
            
            const labels = [];
            const goals = [];
            const acts = [];
            
            const mStart = new Date(m.start);
            const totalDays = (new Date(m.end) - mStart) / 86400000;
            const perDay = (m.startW - m.goalW) / totalDays;
            
            for(let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
                const dStr = d.toISOString().split('T')[0];
                labels.push(d.toLocaleDateString(undefined, {month:'short', day:'numeric'}));
                
                const daysPassed = (d - mStart) / 86400000;
                goals.push(m.startW - (daysPassed * perDay));
                
                const entry = appState.entries.find(e => e.date === dStr);
                acts.push(entry ? entry.weight : null);
            }
            
            chart.data.labels = labels;
            chart.data.datasets = [
                { label: 'Goal', data: goals, borderColor: '#FF7F50', borderDash: [5,5], pointRadius: 0, borderWidth: 1 },
                { label: 'You', data: acts, borderColor: '#008080', backgroundColor: 'rgba(0, 128, 128, 0.1)', borderWidth: 2, spanGaps: true, fill: true }
            ];
            chart.update();
        }

        // --- VISUALS ---
        function cycleFearImage() {
            AudioEngine.playStatic();
            const img = document.getElementById('fear-img');
            appState.imgIndex = (appState.imgIndex + 1) % IMAGE_LIB.length;
            img.src = IMAGE_LIB[appState.imgIndex];
            const q = QUOTES[Math.floor(Math.random()*QUOTES.length)];
            document.getElementById('fear-quote').innerText = `"${q.t}"`;
            document.getElementById('quote-author').innerText = q.a;
        }

        // --- EXPORT/IMPORT ---
        function syncGoogle() {
            const entry = appState.entries.find(e => e.date === document.getElementById('inpDate').value) || appState.currentEntry;
            const w = document.getElementById('inpWeight').value;
            const m = getActiveMission();
            const left = (w - m.goalW).toFixed(1);
            const title = encodeURIComponent(`üö¢ ${m.name}: ${w}lbs (${left} to go)`);
            const desc = encodeURIComponent(`Vibe: ${entry.mood||5}/10\nMeat:${entry.carnivore?'Y':'N'} Walk:${entry.walk?'Y':'N'} Lift:${entry.lift?'Y':'N'} AlcFree:${entry.alcohol?'Y':'N'}\n${document.getElementById('inpNotes').value}`);
            const d = document.getElementById('inpDate').value.replace(/-/g, '');
            window.open(`https://calendar.google.com/calendar/r/eventedit?text=${title}&details=${desc}&dates=${d}/${d}`, '_blank');
        }

        function exportFullICS() {
            const m = getActiveMission();
            let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Mission//EN\n";
            const s = new Date(m.start);
            const e = new Date(m.end);
            const dur = (e-s)/86400000;
            const rate = (m.startW - m.goalW)/dur;
            
            let curr = new Date(s);
            while(curr <= e) {
                const dStr = curr.toISOString().split('T')[0];
                const dClean = dStr.replace(/-/g, '');
                const days = (curr-s)/86400000;
                const tgt = (m.startW - (days*rate)).toFixed(1);
                const entry = appState.entries.find(x => x.date === dStr);
                
                let summ = `üéØ Tgt: ${tgt}`;
                let desc = `Target: ${tgt} lbs`;
                
                if(entry && entry.weight) {
                    summ = `‚úÖ ${entry.weight} / üéØ ${tgt}`;
                    desc += `\nActual: ${entry.weight}\nVibe: ${entry.mood||5}`;
                }
                
                ics += `BEGIN:VEVENT\nDTSTART;VALUE=DATE:${dClean}\nDTEND;VALUE=DATE:${dClean}\nSUMMARY:${summ}\nDESCRIPTION:${desc}\nEND:VEVENT\n`;
                curr.setDate(curr.getDate()+1);
            }
            ics += "END:VCALENDAR";
            const b = new Blob([ics], {type: 'text/calendar'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `${m.name}.ics`; a.click();
        }

        function exportJSON() {
            const b = new Blob([JSON.stringify(appState, null, 2)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'cruise_mission_data.json'; a.click();
        }
        
        function exportCSV() {
            let csv = "Date,Weight,Mood,Meat,Walk,Lift,NoAlc,Notes\n";
            appState.entries.forEach(e => csv += `${e.date},${e.weight||''},${e.mood||5},${e.carnivore},${e.walk},${e.lift},${e.alcohol},"${e.notes||''}"\n`);
            const b = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'data.csv'; a.click();
        }

        function importJSON(input) {
            const r = new FileReader();
            r.onload = e => {
                try {
                    const d = JSON.parse(e.target.result);
                    if(d.entries) appState.entries = d.entries;
                    if(d.missions) appState.missions = d.missions;
                    if(d.activeMissionId) appState.activeMissionId = d.activeMissionId;
                    
                    // Force immediate save and full refresh
                    saveData(true);
                    
                    // Re-initialize state
                    populateMissionSelector();
                    loadMissionParams();
                    
                    // Re-render UI completely
                    refreshUI();
                    
                    alert("DATA IMPORT SUCCESSFUL");
                } catch(err) { alert("IMPORT FAILED"); }
            };
            r.readAsText(input.files[0]);
        }
    </script>
</body>
</html>