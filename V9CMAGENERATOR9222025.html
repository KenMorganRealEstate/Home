<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Real Estate Agent Toolkit - Casora Realty</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.7.1/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-file-upload { border: 2px dashed #cbd5e1; padding: 1.5rem; text-align: center; cursor: pointer; transition: background-color 0.2s; }
        .custom-file-upload:hover { background-color: #f8fafc; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #output-content h2, #output-content h3 { font-size: 1.5em; font-weight: bold; margin-top: 2rem; margin-bottom: 0.5rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.25rem; }
        #output-content h4 { font-size: 1.1em; font-weight: bold; margin-top: 1rem; }
        #output-content table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        #output-content th, #output-content td { border: 1px solid #e2e8f0; padding: 0.5rem; text-align: left; }
        #output-content th { background-color: #f8fafc; }
        .toolkit-btn { width: 100%; text-align: left; padding: 0.75rem 1rem; margin-bottom: 0.5rem; border-radius: 0.5rem; font-weight: bold; transition: all 0.2s; display: flex; align-items: center; justify-content: space-between; }
        .toolkit-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .page-break { page-break-before: always; }
        #output-content details { border: 1px solid #e2e8f0; border-radius: 0.5rem; margin-bottom: 1rem; background-color: #fff; }
        #output-content summary { font-weight: bold; font-size: 1.25rem; padding: 1rem; cursor: pointer; background-color: #f8fafc; border-radius: 0.5rem 0.5rem 0 0; }
        #output-content .details-content { padding: 1rem; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="main-app" class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 flex items-center justify-center flex-col">
            <h1 class="text-4xl font-bold text-gray-900">AI Real Estate Agent Toolkit</h1>
            <p class="text-gray-600 mt-2">Generate a CMA, scripts, marketing content, and more from a single input.</p>
        </header>

        <div class="bg-white p-6 rounded-2xl shadow-lg">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="lg:border-r lg:border-gray-200 lg:pr-8">
                    <h2 class="text-2xl font-semibold mb-4">1. Input Property & Market Data</h2>

                    <div class="mb-6">
                        <label for="subjectAddress" class="block font-medium mb-2">Subject Property Address</label>
                        <input type="text" id="subjectAddress" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., 123 Beddoe Avenue, Hamilton, ON">
                    </div>

                    <div class="mb-6">
                        <label for="subjectDetails" class="block font-medium mb-2">Subject Property Details (Brain Dump)</label>
                        <textarea id="subjectDetails" rows="5" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., 3 beds, 2 baths, 1500 sq ft. Updated kitchen with granite countertops..."></textarea>
                    </div>

                    <div class="mb-6">
                        <label class="block font-medium mb-2">Comparable Listings (PDF, DOCX)</label>
                        <div id="comps-upload-area" class="custom-file-upload rounded-lg">
                            <p>Click or drag to upload all comps (Sold, Active, etc.)</p>
                            <input type="file" id="comps-files" class="hidden" multiple accept=".pdf,.docx,.txt">
                            <p id="comps-file-list" class="text-sm text-gray-500 mt-2"></p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label for="marketAdjustments" class="block font-medium mb-2">Market Adjustment Values (from Deep Research)</label>
                        <textarea id="marketAdjustments" rows="4" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Paste the key-value list for the specific city here. e.g., Finished Basement: $65,000..."></textarea>
                    </div>

                     <div class="mb-6">
                        <label for="marketNotes" class="block font-medium mb-2">Current Market Notes (Optional)</label>
                        <textarea id="marketNotes" rows="3" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., 400 homes for sale, 100 buyers per month, 4 months of inventory..."></textarea>
                    </div>

                    <div class="flex items-center space-x-4">
                        <button id="generate-btn" class="flex-grow bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors text-lg disabled:bg-blue-400">
                            Generate CMA Report
                        </button>
                        <button id="clear-btn" title="Clear All Inputs & Output" class="bg-gray-200 text-gray-700 font-bold p-3 rounded-lg hover:bg-gray-300 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="text-2xl font-semibold">2. Generated Report & Toolkit</h2>
                         <div class="flex items-center space-x-2">
                            <select id="profile-select" class="border rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-blue-500"></select>
                            <button id="save-profile-btn" title="Save current adjustments as a new profile" class="bg-green-100 text-green-800 text-xs font-bold p-2 rounded hover:bg-green-200">Save</button>
                            <button id="delete-profile-btn" title="Delete selected profile" class="bg-red-100 text-red-800 text-xs font-bold p-2 rounded hover:bg-red-200">Delete</button>
                         </div>
                    </div>
                    <div id="toolkit-container" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-2 mb-4">
                        <button id="generate-pricing-script-btn" class="toolkit-btn bg-purple-100 text-purple-800 hover:bg-purple-200">Generate Pricing Script <span class="status"></span></button>
                        <button id="generate-doorknocking-btn" class="toolkit-btn bg-teal-100 text-teal-800 hover:bg-teal-200">Generate Door Knocking Kit <span class="status"></span></button>
                        <button id="generate-marketing-btn" class="toolkit-btn bg-indigo-100 text-indigo-800 hover:bg-indigo-200">Generate Marketing Package <span class="status"></span></button>
                        <button id="generate-objections-btn" class="toolkit-btn bg-pink-100 text-pink-800 hover:bg-pink-200">Generate Objection Handlers <span class="status"></span></button>
                        <button id="generate-followup-btn" class="toolkit-btn bg-yellow-100 text-yellow-800 hover:bg-yellow-200">Generate Follow-up Emails <span class="status"></span></button>
                    </div>
                     <div id="refinement-container" class="hidden mb-4 p-4 border rounded-lg bg-gray-50">
                        <h3 class="text-lg font-semibold mb-2">3. Refine Report</h3>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="refinement-input" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., Put all justifications into a single grid.">
                            <button id="refine-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 disabled:bg-blue-300">Refine</button>
                        </div>
                    </div>
                    <div id="output-container" class="border rounded-lg p-6 h-[550px] overflow-y-auto bg-gray-50 relative">
                        <div id="placeholder" class="text-center text-gray-500 flex flex-col items-center justify-center h-full">
                            <svg class="w-12 h-12 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2-2z"></path></svg>
                            <p>Your generated report and toolkit components will appear here.</p>
                        </div>
                        <div id="loader" class="hidden items-center justify-center h-full flex-col">
                            <div class="loader"></div>
                            <p id="loader-text" class="mt-4 text-gray-600">Analyzing data and generating report...</p>
                        </div>
                        <div id="output-content"></div>
                         <div id="action-buttons" class="hidden text-right py-4 px-2 space-x-2 bg-white bg-opacity-80 backdrop-blur-sm sticky bottom-0 -mx-6 -mb-6 mt-4 border-t border-gray-200">
                           <button id="print-report-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 text-sm">Print / PDF</button>
                           <button id="copy-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 text-sm">Copy All</button>
                           <button id="download-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 text-sm">Download (.md)</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- AGENT & API CONFIGURATION ---
    // IMPORTANT: Replace 'YOUR_API_KEY_HERE' with your actual Google AI API key.
    const apiKey = 'AIzaSyD_UWXt1n74XpsmjUWHYZJwIyBngsbijg4';

    const agentProfile = {
        name: "Ken Morgan",
        brokerage: "Casora Realty Inc.",
        email: "sales@kenmorgan.ca",
        website: "www.kenmorgan.ca",
        phone: "(905) 630-1225"
    };

    // --- DOM Element References ---
    const compsUploadArea = document.getElementById('comps-upload-area');
    const compsFilesInput = document.getElementById('comps-files');
    const compsFileList = document.getElementById('comps-file-list');
    const generateBtn = document.getElementById('generate-btn');
    const clearBtn = document.getElementById('clear-btn');
    const toolkitContainer = document.getElementById('toolkit-container');
    const refinementContainer = document.getElementById('refinement-container');
    const refinementInput = document.getElementById('refinement-input');
    const refineBtn = document.getElementById('refine-btn');
    const actionButtons = document.getElementById('action-buttons');
    const copyBtn = document.getElementById('copy-btn');
    const downloadBtn = document.getElementById('download-btn');
    const printReportBtn = document.getElementById('print-report-btn');
    const placeholder = document.getElementById('placeholder');
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const outputContent = document.getElementById('output-content');
    const profileSelect = document.getElementById('profile-select');
    const saveProfileBtn = document.getElementById('save-profile-btn');
    const deleteProfileBtn = document.getElementById('delete-profile-btn');
    const marketAdjustmentsTextarea = document.getElementById('marketAdjustments');

    const showdownConverter = new showdown.Converter({ tables: true, ghCompatibleHeaderId: true });
    let fullReportMarkdown = '';

    const toolkitButtons = {
        pricingScript: document.getElementById('generate-pricing-script-btn'),
        doorKnocking: document.getElementById('generate-doorknocking-btn'),
        marketing: document.getElementById('generate-marketing-btn'),
        objections: document.getElementById('generate-objections-btn'),
        followUp: document.getElementById('generate-followup-btn'),
    };

    // --- EVENT LISTENERS ---
    window.addEventListener('DOMContentLoaded', loadMarketProfiles);
    compsUploadArea.addEventListener('click', () => compsFilesInput.click());
    compsUploadArea.addEventListener('dragover', (e) => e.preventDefault());
    compsUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        compsFilesInput.files = e.dataTransfer.files;
        updateFileList(compsFilesInput);
    });
    compsFilesInput.addEventListener('change', () => updateFileList(compsFilesInput));
    generateBtn.addEventListener('click', handleCmaGeneration);
    clearBtn.addEventListener('click', clearAllInputs);
    saveProfileBtn.addEventListener('click', saveMarketProfile);
    deleteProfileBtn.addEventListener('click', deleteMarketProfile);
    profileSelect.addEventListener('change', loadSelectedProfile);
    refineBtn.addEventListener('click', handleRefinement);


    Object.entries(toolkitButtons).forEach(([key, button]) => {
        const promptBuilderName = `build${key.charAt(0).toUpperCase() + key.slice(1)}Prompt`;
        const promptBuilder = window[promptBuilderName];
        const sectionTitle = button.textContent.replace('Generate ', '').replace(/\sKit$/, '').replace(/\sPackage$/, '');
        
        if (typeof promptBuilder === 'function') {
            button.addEventListener('click', () => handleToolkitGeneration(button, promptBuilder, sectionTitle));
        } else {
            console.error(`Prompt builder function ${promptBuilderName} not found.`);
        }
    });

    printReportBtn.addEventListener('click', () => {
        const printableHtml = generatePrintableHtml(fullReportMarkdown);
        const newWindow = window.open();
        newWindow.document.write(printableHtml);
        newWindow.document.close();
    });

    copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(fullReportMarkdown).then(() => {
            alert('Full report copied to clipboard!');
        }, () => {
            alert('Failed to copy report.');
        });
    });

    downloadBtn.addEventListener('click', () => {
        const subjectAddress = document.getElementById('subjectAddress').value.trim().replace(/[^a-zA-Z0-9]/g, '-') || 'CMA-Report';
        const filename = `AI-Toolkit-Report-${subjectAddress}.md`;
        const blob = new Blob([fullReportMarkdown], { type: 'text/markdown' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    });

    // --- CORE FUNCTIONS ---

    function updateFileList(input) {
        if (input.files.length > 0) {
            compsFileList.innerHTML = Array.from(input.files).map(f => f.name).join('<br>');
        } else {
            compsFileList.innerHTML = '';
        }
    }

    function clearAllInputs() {
        document.getElementById('subjectAddress').value = '';
        document.getElementById('subjectDetails').value = '';
        compsFilesInput.value = '';
        compsFileList.innerHTML = '';
        marketAdjustmentsTextarea.value = '';
        document.getElementById('marketNotes').value = '';
        outputContent.innerHTML = '';
        fullReportMarkdown = '';
        placeholder.style.display = 'flex';
        actionButtons.classList.add('hidden');
        toolkitContainer.classList.add('hidden');
        refinementContainer.classList.add('hidden');
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate CMA Report';
        Object.values(toolkitButtons).forEach(btn => {
            btn.disabled = false;
            btn.querySelector('.status').textContent = '';
        });
    }

    async function handleCmaGeneration() {
        const subjectAddress = document.getElementById('subjectAddress').value.trim();
        const subjectDetails = document.getElementById('subjectDetails').value.trim();
        
        if (apiKey === 'YOUR_API_KEY_HERE') {
            alert('Please hardcode your API key in the HTML file first.');
            return;
        }
        if (!subjectAddress || !subjectDetails || compsFilesInput.files.length === 0) {
            alert('Please provide a subject address, subject details, and at least one comparable listings file.');
            return;
        }

        // Reset UI for new generation
        placeholder.style.display = 'none';
        outputContent.innerHTML = '';
        fullReportMarkdown = '';
        loaderText.textContent = 'Analyzing data and generating CMA...';
        loader.style.display = 'flex';
        generateBtn.disabled = true;
        generateBtn.textContent = 'Generating...';
        actionButtons.classList.add('hidden');
        toolkitContainer.classList.add('hidden');
        refinementContainer.classList.add('hidden');
        Object.values(toolkitButtons).forEach(btn => {
            btn.disabled = false;
            btn.querySelector('.status').textContent = '';
        });

        try {
            const apiParts = await Promise.all(Array.from(compsFilesInput.files).map(fileToGenerativePart));
            const marketNotes = document.getElementById('marketNotes').value.trim();
            const marketAdjustments = marketAdjustmentsTextarea.value.trim();
            const cmaPrompt = buildCmaPrompt(subjectAddress, subjectDetails, marketNotes, marketAdjustments);

            const cmaMarkdown = await callGeminiAPIWithRetry(cmaPrompt, apiParts);
            fullReportMarkdown = cmaMarkdown;

            const cmaHtml = showdownConverter.makeHtml(cmaMarkdown);
            outputContent.innerHTML = cmaHtml;

            actionButtons.classList.remove('hidden');
            toolkitContainer.classList.remove('hidden');
            refinementContainer.classList.remove('hidden');
        } catch (error) {
            outputContent.innerHTML = `<p class="text-red-500"><strong>Error generating CMA:</strong> ${error.message}</p>`;
        } finally {
            loader.style.display = 'none';
            generateBtn.disabled = false;
            generateBtn.textContent = 'Regenerate CMA Report';
        }
    }

    async function handleToolkitGeneration(button, promptBuilder, sectionTitle) {
        if (apiKey === 'YOUR_API_KEY_HERE') {
            alert('Please hardcode your API key in the HTML file first.');
            return;
        }
        const statusSpan = button.querySelector('.status');
        button.disabled = true;
        statusSpan.textContent = '⚙️ Generating...';
        try {
            const prompt = promptBuilder();
            const newMarkdown = await callGeminiAPIWithRetry(prompt);

            fullReportMarkdown += `\n\n---\n\n${newMarkdown}`; // Append to full report
            const newHtml = showdownConverter.makeHtml(newMarkdown);
            
            const sectionWrapper = document.createElement('div');
            sectionWrapper.innerHTML = newHtml;

            // Add page break class to the first H* element for printing
            const header = sectionWrapper.querySelector('h1, h2, h3, h4, h5, h6');
            if(header) header.classList.add('page-break');
            
            outputContent.appendChild(sectionWrapper);
            outputContent.scrollTop = outputContent.scrollHeight; // Auto-scroll to bottom
            statusSpan.textContent = '✅';
        } catch (error) {
            const errorP = document.createElement('p');
            errorP.className = 'text-red-500 p-4';
            errorP.innerHTML = `<strong>Error generating ${sectionTitle}:</strong> ${error.message}`;
            outputContent.appendChild(errorP);
            statusSpan.textContent = '❌ Error';
            button.disabled = false; // Re-enable on error
        }
    }

     async function handleRefinement() {
        if (apiKey === 'YOUR_API_KEY_HERE') {
            alert('Please hardcode your API key in the HTML file first.');
            return;
        }
        const instruction = refinementInput.value.trim();
        if (!instruction || !fullReportMarkdown) {
            alert('Please generate a report first and then provide a refinement instruction.');
            return;
        }

        loaderText.textContent = 'Refining report...';
        loader.style.display = 'flex';
        refineBtn.disabled = true;

        try {
            const prompt = `**ROLE:** You are a document formatting expert.
            **TASK:** Take the following Markdown document and revise it ONLY according to this user instruction: "${instruction}".
            Ensure the output remains valid, well-structured Markdown. Do not add commentary, just the revised document.
            ---
            **DOCUMENT TO REFINE:**
            ${fullReportMarkdown}`;
            
            const refinedMarkdown = await callGeminiAPIWithRetry(prompt);
            fullReportMarkdown = refinedMarkdown; // Update the master document
            
            const refinedHtml = showdownConverter.makeHtml(refinedMarkdown);
            outputContent.innerHTML = refinedHtml;
            refinementInput.value = ''; // Clear input after success
        } catch (error) {
             outputContent.innerHTML += `<p class="text-red-500 mt-4"><strong>Error refining report:</strong> ${error.message}</p>`;
        } finally {
            loader.style.display = 'none';
            refineBtn.disabled = false;
        }
    }

    // --- MARKET PROFILE (LOCALSTORAGE) FUNCTIONS ---
    function getSavedProfiles() {
        return JSON.parse(localStorage.getItem('marketProfiles') || '{}');
    }

    function saveMarketProfile() {
        const profileName = prompt("Enter a name for this market profile (e.g., Burlington, Waterdown):");
        if (!profileName || profileName.trim() === '') return;

        const profiles = getSavedProfiles();
        profiles[profileName.trim()] = marketAdjustmentsTextarea.value;
        localStorage.setItem('marketProfiles', JSON.stringify(profiles));
        loadMarketProfiles();
        profileSelect.value = profileName.trim();
        alert(`Profile "${profileName.trim()}" saved!`);
    }

    function loadMarketProfiles() {
        const profiles = getSavedProfiles();
        const currentSelection = profileSelect.value;
        profileSelect.innerHTML = '<option value="">Load a Market Profile...</option>';
        for (const name in profiles) {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            profileSelect.appendChild(option);
        }
        if (currentSelection && profiles[currentSelection]) {
            profileSelect.value = currentSelection;
        }
    }

    function loadSelectedProfile() {
        const selectedProfile = profileSelect.value;
        if (!selectedProfile) {
            marketAdjustmentsTextarea.value = '';
            return;
        }
        const profiles = getSavedProfiles();
        marketAdjustmentsTextarea.value = profiles[selectedProfile] || '';
    }

    function deleteMarketProfile() {
        const selectedProfile = profileSelect.value;
        if (!selectedProfile) {
            alert("Please select a profile to delete.");
            return;
        }
        if (confirm(`Are you sure you want to delete the "${selectedProfile}" profile?`)) {
            const profiles = getSavedProfiles();
            delete profiles[selectedProfile];
            localStorage.setItem('marketProfiles', JSON.stringify(profiles));
            loadMarketProfiles();
            marketAdjustmentsTextarea.value = '';
            alert(`Profile "${selectedProfile}" deleted.`);
        }
    }

    // --- API & PROMPT ENGINEERING ---
    async function callGeminiAPIWithRetry(prompt, parts = [], retries = 4, delay = 2000) {
        const model = "gemini-1.5-flash-latest";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        const requestPayload = {
            contents: [{ parts: [{ text: prompt }, ...parts] }],
            generationConfig: { temperature: 0.4, responseMimeType: "text/plain" }
        };

        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestPayload)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const candidate = data.candidates?.[0];
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return candidate.content.parts[0].text;
                    } else {
                       throw new Error("API returned an empty or invalid response. The content may have been blocked due to safety settings.");
                    }
                }

                if (response.status === 429 || response.status >= 500) {
                    console.warn(`API is overloaded. Retrying...`);
                    loaderText.textContent = `Server is busy. Retrying... (Attempt ${i + 1})`;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                } else {
                    const errorData = await response.json();
                    throw new Error(`API Error (${response.status}): ${errorData.error?.message || 'Unknown API error'}`);
                }
            } catch (error) {
               if (i === retries - 1) throw error;
               console.warn(`Network error. Retrying...`, error);
               loaderText.textContent = `Network error. Retrying...`;
               await new Promise(resolve => setTimeout(resolve, delay));
               delay *= 2;
            }
        }
        throw new Error('API failed to respond after multiple retries.');
    }

    // -- PROMPT BUILDER FUNCTIONS --
    function buildCmaPrompt(subjectAddress, subjectDetails, marketNotes, marketAdjustments) {
         return `**ROLE:** You are an expert real estate analyst preparing a professional, client-facing Comparative Market Analysis (CMA) document.
        **CONTEXT:** The subject property is **${subjectAddress}** with these details: "${subjectDetails}". I have provided comparable listings as file uploads. Additional market notes are: "${marketNotes || 'None provided.'}"
        **MANDATORY OUTPUT STRUCTURE:** You MUST generate the report in the following sequence and with the exact headings specified.

        ### 1. Comparable Property Data
        Create a Markdown table summarizing the key data for each comparable property. Columns: 'Property Address', 'Status', 'Price', 'Beds', 'Baths', 'SqFt', 'Garage', 'Year Built', 'Lot Features', 'Basement Finish'.

        ### 2. Selection of Best Comparables
        - **Best Sold Comparables:** List the top 3 sold properties and write a brief sentence for each explaining why it's a strong comparable.
        - **Best Active Comparables:** List the top 3 active properties and write a brief sentence for each explaining its relevance.

        ### 3. Neighborhood Profile & Market Insights
        Write a paragraph about the neighborhood, incorporating these user-provided market notes if available: "${marketNotes}".

        ### 4. CMA Adjustment Grid
        This is the most critical section. You MUST create a detailed Markdown table showing adjustments.
        - **Columns:** 'Property Address', 'Original Price', 'SqFt Adj', 'Age Adj', 'Brick Adj', 'Finished Bsmt Adj', 'Extra Bath Adj', 'Hardwood Adj', 'Total Adj', 'Adjusted Price'.
        - **Adjustment Logic:** Use the following values for adjustments: "${marketAdjustments}". If a value is not provided, use a reasonable estimate and note it.
        - After the table, add a "Note:" paragraph explaining the logic (e.g., "The 'SqFt Adj' represents the difference in square footage...").

        ### 5. Price Recommendation
        Provide a concise paragraph with a recommended price range based on the adjusted prices of the sold comparables.

        ### 6. Disclaimer
        Include a standard disclaimer that this CMA is for informational purposes and not a formal appraisal.

        **FINAL INSTRUCTION:** Format the ENTIRE output as a single, professional report using Markdown. Do not include any other toolkit components yet.`;
    }

    function buildPricingScriptPrompt() {
        const marketNotes = document.getElementById('marketNotes').value.trim();
        return `**ROLE:** You are an expert real estate sales strategist and coach for agent ${agentProfile.name} of ${agentProfile.brokerage}.
            **CONTEXT:** You are creating a script for ${agentProfile.name} to use when presenting the CMA and pricing strategy to a client. The full CMA report is in the prior message history. The agent also provided these critical market stats: "${marketNotes || 'Crucial market stats were not provided.'}"
            **TASK:** Generate a "Pricing Conversation Script". The script MUST be:
            1.  Personalized for ${agentProfile.name}.
            2.  Conversational and persuasive.
            3.  Use powerful metaphors to explain market dynamics (e.g., "comparison shopping," "the river of inventory," "price as a lure").
            4.  Directly weave in the numbers from the "CRITICAL MARKET NOTES" to create urgency and justify the pricing strategy.
            5.  Conclude by asking the seller for their opinion on the price, leading them to the logical conclusion.
            Format the output using Markdown with a clear heading.`;
    }

    function buildDoorKnockingPrompt() {
        const subjectAddress = document.getElementById('subjectAddress').value.trim();
        return `**ROLE:** You are an elite real estate coach creating hyper-practical scripts for agent ${agentProfile.name} of ${agentProfile.brokerage}.
            **CONTEXT:** You are creating a door-knocking kit for ${agentProfile.name} who has the CMA for **${subjectAddress}** and will hold an open house there. The full CMA is in the prior text.
            **TASK:** Generate a "Door Knocking Kit: Open House Invitation".
            1.  The script must be personalized for ${agentProfile.name} and mention ${agentProfile.brokerage}.
            2.  It must be friendly, confident, and value-driven.
            3.  It must include a section for "What you'll need".
            4.  It must include a script to invite neighbors and pivot to offering a market update.
            5.  It must include a section with 3 distinct mock dialogue scenarios: "The Friendly & Curious Homeowner," "The Busy & Dismissive Homeowner," and "The Potential Future Seller."
            Format the entire output in Markdown.`;
    }

    function buildMarketingPrompt() {
        const subjectAddress = document.getElementById('subjectAddress').value.trim();
        const subjectDetails = document.getElementById('subjectDetails').value.trim();
        return `**ROLE:** You are a creative real estate marketing copywriter for ${agentProfile.name} of ${agentProfile.brokerage}.
            **CONTEXT:** You need to create a marketing package for a new listing at **${subjectAddress}**. The agent's raw notes are: "${subjectDetails}".
            **TASK:** Generate a "Property Marketing Package" with the following components, formatted in Markdown. All components must be branded for Ken Morgan and Casora Realty Inc., including his contact info where appropriate.
            1.  **Compelling MLS Listing Description:** Write a captivating, professional property description based on the agent's notes. Use evocative language.
            2.  **Instagram Post & TikTok Idea:** Write a short, punchy Instagram caption. Use emojis and relevant local hashtags. Then, provide a simple concept for a 15-30 second TikTok/Reels video, including visual ideas and a trending audio suggestion.
            3.  **Facebook & LinkedIn Post:** Write a slightly longer, more detailed post suitable for both Facebook and a professional LinkedIn audience, encouraging shares and comments.
            4.  **YouTube Video Script Outline:** Provide a script outline for a 60-90 second video walkthrough. Include an engaging hook, key features to highlight room-by-room, and a strong call-to-action at the end.
            5.  **Feature Sheet Headline & Opening Paragraph:** Write a powerful headline and introductory paragraph for a print feature sheet.`;
    }

    function buildObjectionsPrompt() {
        const marketNotes = document.getElementById('marketNotes').value.trim();
        return `**ROLE:** You are a seasoned real estate sales coach training ${agentProfile.name}.
            **CONTEXT:** ${agentProfile.name} needs scripts to handle common seller objections during a listing presentation. The current market context is: "${marketNotes || 'No specific market notes provided.'}" The full CMA is also available in the history for context.
            **TASK:** Generate a "Seller Objection Handling Guide" in Markdown. Provide empathetic, logical, and persuasive responses for ${agentProfile.name} to the following common objections.
            1.  **"We want to list for a higher price and test the market."** (Use an analogy about the "golden window" of a new listing's first few weeks and how overpricing helps the competition sell).
            2.  **"Another agent said they could get us a higher price."** (Provide a script that differentiates based on a data-backed strategy versus an unsubstantiated price promise).
            3.  **"Why is your commission so high? / Can you do it for less?"** (Provide a value-based response that frames the commission as an investment in a superior, proactive marketing system that leads to a higher net price for the seller).`;
    }

    function buildFollowUpPrompt() {
        const subjectAddress = document.getElementById('subjectAddress').value.trim();
        return `**ROLE:** You are an organized and personable real estate assistant for ${agentProfile.name} of ${agentProfile.brokerage}.
            **CONTEXT:** ${agentProfile.name} has just finished a listing presentation for **${subjectAddress}** and also went door-knocking in the neighborhood.
            **TASK:** Write two distinct email templates in Markdown format, fully personalized with ${agentProfile.name}'s contact details (${agentProfile.email}, ${agentProfile.phone}, ${agentProfile.website}).
            ### 1. Post-Presentation "Thank You & Recap" Email
            **Audience:** The potential sellers at ${subjectAddress}.
            **Goal:** To thank them, briefly recap the recommended list price from the CMA, reinforce the "Active vs. Passive" value proposition, and outline clear next steps.
            ### 2. "Nice to Meet You" Nurture Email
            **Audience:** A neighbor met while door-knocking who expressed mild curiosity.
            **Goal:** To be a friendly, no-pressure follow-up that provides value (like a link to a market report or your website) and keeps ${agentProfile.name} top-of-mind for future real estate needs.`;
    }
    // --- UTILITY FUNCTIONS ---
    function fileToGenerativePart(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            if (file.type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document") {
                reader.onload = (event) => {
                    mammoth.extractRawText({ arrayBuffer: event.target.result })
                      .then(result => resolve({ text: `\n--- DOC: ${file.name} ---\n${result.value}\n--- END DOC ---\n` }))
                      .catch(reject);
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            } else if (file.type === 'application/pdf') {
                reader.onload = () => resolve({ inlineData: { mimeType: 'application/pdf', data: reader.result.split(',')[1] } });
                reader.onerror = reject;
                reader.readAsDataURL(file);
            } else {
                 reader.onload = (event) => {
                    resolve({ text: `\n--- TXT: ${file.name} ---\n${event.target.result}\n--- END TXT ---\n` });
                };
                reader.onerror = reject;
                reader.readAsText(file);
            }
        });
    }

    function generatePrintableHtml(markdownContent) {
        const subjectAddress = document.getElementById('subjectAddress').value.trim();
        const clientName = "Valued Client"; // You can make this dynamic later if needed
        const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

        const headerHtml = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #3b82f6; padding-bottom: 20px;">
                <div>
                    <h1 style="font-size: 28px; font-weight: bold; color: #1e3a8a; margin: 0;">Comparative Market Analysis (CMA)</h1>
                    <p style="margin: 5px 0 0; color: #4b5563;"><strong>Subject Property:</strong> ${subjectAddress}</p>
                </div>
                <div style="text-align: right; color: #4b5563;">
                    <p style="margin: 0;"><strong>Date:</strong> ${today}</p>
                    <p style="margin: 5px 0 0;"><strong>Prepared for:</strong> ${clientName}</p>
                    <p style="margin: 5px 0 0;"><strong>Prepared by:</strong> ${agentProfile.name}, ${agentProfile.brokerage}</p>
                </div>
            </div>`;

        const htmlContent = showdownConverter.makeHtml(markdownContent.replace(/---/g, ''));
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlContent;

        // --- Chart Generation Logic ---
        let chartHtml = '';
        try {
            const allTables = tempDiv.querySelectorAll('table');
            // Find the adjustment grid table specifically
            const adjustmentGridHeader = Array.from(tempDiv.querySelectorAll('h3, h4')).find(h => h.textContent.toLowerCase().includes('adjustment grid'));
            const adjustmentTable = adjustmentGridHeader ? adjustmentGridHeader.nextElementSibling : null;
            
            if (adjustmentTable && adjustmentTable.tagName === 'TABLE') {
                const headers = Array.from(adjustmentTable.querySelectorAll('thead th')).map(th => th.textContent.trim().toLowerCase());
                const priceIndex = headers.findIndex(h => h.includes('adjusted price'));
                const addressIndex = headers.findIndex(h => h.includes('property address'));

                if (priceIndex !== -1 && addressIndex !== -1) {
                    const rows = Array.from(adjustmentTable.querySelectorAll('tbody tr'));
                    const chartData = rows.map(row => {
                        const cells = row.querySelectorAll('td');
                        const priceText = cells[priceIndex].textContent.trim().replace(/[^0-9.-]+/g, "");
                        return {
                            label: cells[addressIndex].textContent.trim(),
                            value: parseFloat(priceText) || 0
                        };
                    }).filter(d => d.value > 0);

                    const maxValue = Math.max(...chartData.map(d => d.value));
                    
                    chartHtml = `<div style="padding: 20px 0; margin-top: 20px;">
                        <h3 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 15px; color: #1e3a8a;">Adjusted Price Comparison</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${chartData.map(item => `
                                <div style="display: grid; grid-template-columns: 200px 1fr; align-items: center; margin-bottom: 5px; font-size: 14px;">
                                    <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px;">${item.label}</div>
                                    <div style="flex-grow: 1; background-color: #e5e7eb; border-radius: 5px;">
                                        <div style="width: ${(item.value / maxValue) * 100}%; background-color: #3b82f6; color: white; text-align: right; padding: 5px 10px; border-radius: 5px; white-space: nowrap;">
                                            $${item.value.toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                }
            }
        } catch (e) {
            console.error("Chart generation failed:", e);
            chartHtml = '<p>Could not generate price comparison chart.</p>';
        }

        if (adjustmentGridHeader) {
            adjustmentGridHeader.insertAdjacentHTML('beforebegin', chartHtml);
        }

        const finalHtml = tempDiv.innerHTML;

        return `<html><head><title>CMA Report for ${subjectAddress}</title><style>
                    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; background-color: #fff; }
                    .page { padding: 50px; }
                    h1, h2, h3, h4 { color: #1e3a8a; font-weight: 700; }
                    h3 { font-size: 1.5rem; border-bottom: 1px solid #d1d5db; padding-bottom: 8px; margin-top: 40px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 12px; }
                    th, td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; }
                    th { background-color: #f3f4f6; font-weight: 600; }
                    tr:nth-child(even) { background-color: #f9fafb; }
                    p { margin-bottom: 1rem; }
                    .script-page { page-break-before: always; }
                    @media print {
                       #print-controls { display: none; }
                       body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                       .page { padding: 0; }
                    }
                </style></head><body>
                <div id="print-controls" style="position: fixed; top: 15px; right: 20px; z-index: 100;">
                    <button onclick="window.print()" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Print / Save PDF</button>
                </div>
                <div class="page">${headerHtml}${finalHtml.replace(/<h3>(.*?)<\/h3>/g, (match, p1) => `<h3 class="${p1.toLowerCase().includes('script') ? 'script-page' : ''}">${p1}</h3>`)}</div>
            </body></html>`;
    }

</script>

</body>
</html>

